<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- 更改標題以符合新的風格 -->
    <title>旅遊計畫 | 2026寒假東京外郊親子行</title>
    <link rel="manifest" href="manifest.json">
	<link rel="apple-touch-icon" href="icon.png">
	<meta name="theme-color" content="#F5F5F5">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- EmailJS for sending reports -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=JetBrains+Mono:wght@500&family=Mountains+of+Christmas:wght=700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* CSS 變數定義 */
        :root {
            /* 主體顏色 */
            --bg-main: #F5F5F5;
            --color-text: #333333;
            --color-subtle-text: #6b7280; /* Gray-500 */
            --color-text-inverse: #ffffff;

            /* 卡片和玻璃效果 */
            --bg-glass: rgba(255, 255, 255, 0.85);
            --border-glass: rgba(0, 0, 0, 0.05);
            --bg-card-sub: #f3f4f6; /* Gray-100 */
            --border-card-sub: #d1d5db; /* Gray-300 */

            /* 強調色 (Morandi Pink) */
            --accent-pink: #FFC8DD;
            --accent-pink-dark: #E07A5F;
            --accent-blue: #A0B7C6; /* Morandi Blue */
            --accent-blue-dark: #86A2B3;
        }

        /* 樣式切換器：根據主題調整顏色 */
        .theme-DarkChristmas {
            --bg-main: #0f172a;
            --color-text: #E2E8F0;
            --color-subtle-text: #94a3b8;
            --color-text-inverse: #0f172a;
            --bg-glass: rgba(30, 41, 59, 0.75);
            --border-glass: rgba(255, 255, 255, 0.1);
            --bg-card-sub: #1e293b;
            --border-card-sub: #475569;
            --accent-pink: #DC2626; /* Christmas Red */
            --accent-pink-dark: #FF6B6B; /* Bright Red */
            --accent-blue: #4ECDC4; /* Teal */
            --accent-blue-dark: #3dbdb4;
        }
        .theme-DarkMorandi {
            --bg-main: #1a202c;
            --color-text: #D4D4D8;
            --color-subtle-text: #A0A0A0;
            --color-text-inverse: #1a202c;
            --bg-glass: rgba(45, 55, 72, 0.7);
            --border-glass: rgba(255, 255, 255, 0.1);
            --bg-card-sub: #334155;
            --border-card-sub: #475569;
            --accent-pink: #E4C7C2; /* Soft Rose */
            --accent-pink-dark: #DDA0A0;
            --accent-blue: #A0B7C6;
            --accent-blue-dark: #86A2B3;
        }
        .theme-PinkMorandi {
            /* 保持 Light Pink Morandi 的預設值 */
        }
        /* NEW: Green Morandi Style */
        .theme-GreenMorandi {
             --bg-main: #F9F7F3; /* 淺米白/灰白 */
             --color-text: #333333;
             --color-subtle-text: #71717A; /* Stone-500 */
             --color-text-inverse: #ffffff;
             --bg-glass: rgba(255, 255, 255, 0.85);
             --border-glass: rgba(0, 0, 0, 0.05);
             --bg-card-sub: #f3f4f6;
             --border-card-sub: #d1d5db;

             --accent-pink: #E4C7C2; /* 淺柔粉 (作為強調色 1) */
             --accent-pink-dark: #DDA0A0; /* 淺暖橘 */
             --accent-blue: #A8B5A3; /* 柔和灰綠 (作為強調色 2) */
             --accent-blue-dark: #7D8B7E; /* 沉穩深綠 */
        }


        /* ------------------- BASE STYLES ------------------- */
        html, body {
            background-color: var(--bg-main); 
            color: var(--color-text); 
            font-family: 'Noto Sans TC', sans-serif; 
            overflow-x: hidden;
            background-image: none;
        }
        #snow-container, #fireworks-container { display: none; } 
        .snowflake, @keyframes snowfall, .firework, @keyframes firework { visibility: hidden !important; }

        #root { position: relative; z-index: 10; }
        
        /* Glass Panel */
        .glass-panel { 
            background: var(--bg-glass);
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px); 
            border: 1px solid var(--border-glass);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            transition: all 0.3s ease; 
        }
        .typing-indicator span { animation: blink 1.4s infinite both; } .typing-indicator span:nth-child(2) { animation-delay: 0.2s; } .typing-indicator span:nth-child(3) { animation-delay: 0.4s; } @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Neon Text (主標題/logo) */
        .neon-text { 
            color: var(--color-text);
            text-shadow: 
                0 0 1px var(--color-text),       
                0 0 4px var(--accent-pink),     
                0 0 8px var(--accent-pink);     
        }
        /* Neon Text Blue (總花費金額/重點強調) */
        .neon-text-blue {
            color: var(--accent-pink-dark); 
            text-shadow: 
                0 0 1px var(--accent-pink-dark),
                0 0 4px var(--accent-pink), 
                0 0 8px var(--accent-pink);
        }
        
        /* Markdown 樣式 */
        .markdown-content ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; } .markdown-content ol { list-style-type: decimal; padding-left: 1.2em; margin-bottom: 0.5em; } .markdown-content p { margin-bottom: 0.5em; } 
        .markdown-content strong { color: var(--accent-blue); } 
        .markdown-content a { color: var(--accent-pink-dark); text-decoration: underline; }

        /* GuardTab 專用風格 */
        .guard-card {
             border-left: 3px solid var(--accent-pink); 
             background: rgba(255, 200, 221, 0.15); 
        }
        /* 使用 Accent-Blue 作為 AI Result 的邊框色 */
        .ai-result-box {
            background: var(--bg-card-sub); 
            border: 1px solid var(--accent-blue);
            color: var(--color-text);
        }
        
        /* 主題切換按鈕樣式 */
        .theme-switcher-btn {
            background-color: var(--accent-pink-dark);
            color: var(--color-text-inverse);
            box-shadow: 0 2px 0px var(--accent-blue-dark); /* 調整陰影以適應導航欄 */
            transition: all 0.2s ease;
        }
        .theme-switcher-btn:hover {
            background-color: var(--accent-blue-dark);
            box-shadow: 0 2px 0px var(--accent-pink-dark);
        }
        .theme-switcher-btn:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        
        /* 手機模式下的切換按鈕，移除底下的圓形浮動按鈕，改為導航列內聯 */
        .nav-button-wrapper {
             flex: 1;
             display: flex;
             justify-content: center;
             align-items: center;
        }
        
        /* 頂部按鈕容器樣式 */
        .navbar-actions > button {
             padding: 0.5rem;
             border-radius: 9999px; /* Full circle */
             width: 40px;
             height: 40px;
             display: flex;
             align-items: center;
             justify-content: center;
        }
        /* 針對風格切換 Modal 的樣式 */
        .theme-select-btn {
             background-color: var(--bg-card-sub);
             color: var(--color-text);
             transition: all 0.2s;
        }
        .theme-select-btn:hover {
             background-color: var(--accent-pink);
             color: var(--color-text);
        }
    </style>
</head>
<body className={`theme-${THEMES[0].name}`}>
    
    <!-- 移除聖誕夜雪花與煙火背景效果 -->
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- Lucide Icons 定義 (提前定義以避免 ReferenceError) ---
        const Icons = {
            Plane: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 12h5"/><path d="M13 12h3"/><path d="M19.74 7.33a2.3 2.3 0 0 1 2.93 2.93l-3.33 3.33a2.3 2.3 0 0 1-3.25 0l-7.34-7.34a2.3 2.3 0 0 1 0-3.25l3.33-3.33z"/><path d="M14.66 14.66 9 22H2l2.5-9"/><path d="M7 17l-5 5"/></svg>,
            Smile: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg>,
            List: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            LayoutGrid: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>,
            Calculator: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/></svg>,
            Clock: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Wallet: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></svg>,
            MapPin: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            Ticket: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></svg>,
            ExternalLink: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>,
            Footprints: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 11 3.8 11 8c0 1.25-.38 2-1.28 2.55-.4.25-.72.82-.72 1.25V16a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 2 13 3.8 13 8c0 1.25.38 2 1.28 2.55.4.25.72.82.72 1.25V16a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2z"/></svg>,
            Car: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H7.7c-.7 0-1.3.3-1.8.7-.9.9-2.2 2.3-2.2 2.3S1 10.6 1 11.1c-.8.2-1.5 1-1.5 1.9v3c0 .6.4 1 1 1h2"/><path d="M2.5 17a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"/><path d="M16.5 17a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"/><path d="M12 9V6"/></svg>,
            Navigation: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>,
            Hotel: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2Z"/><polyline points="7 2 7 20"/><polyline points="17 2 17 20"/><line x1="2" x2="22" y1="12" y2="12"/><line x1="2" x2="22" y1="17" y2="17"/></svg>,
            Star: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            X: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Coffee: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M10 2v2"/><path d="M14 2v2"/><path d="M6 2v2"/><path d="M18 8a1 1 0 0 1 1 1v2a3 3 0 0 1-3 3h-2.95a1 1 0 0 0-.768.369l-.254.332a4 4 0 0 1-3.26 1.623 4 4 0 0 1-3.296-1.402l-.125-.153A1 1 0 0 0 4.35 14H4a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1h14z"/><path d="M18 14v1a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-1"/></svg>,
            ShoppingBag: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>,
            Fuel: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="3" x2="15" y1="22" y2="22"/><line x1="4" x2="14" y1="9" y2="9"/><path d="M14 22V4a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v18"/><path d="M14 13h2a2 2 0 0 1 2 2v2a2 2 0 0 0 2 2h0a2 2 0 0 0 2-2V9.83a2 2 0 0 0-.59-1.42L18 5"/></svg>,
            Sun: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            CloudSnow: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M8 15h.01"/><path d="M8 19h.01"/><path d="M12 17h.01"/><path d="M12 21h.01"/><path d="M16 15h.01"/><path d="M16 19h.01"/></svg>,
            CloudRain: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M16 14v6"/><path d="M8 14v6"/><path d="M12 16v6"/></svg>,
            Cloud: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.2-3.4-3.1-6-6.5-6-3.7 0-6.6 2.8-6.9 6.4h-.1C2.1 16.4 0 18.5 0 21c0 2.2 1.8 4 4 4h13.5c2.2 0 4-1.8 4-4"/></svg>,
            Edit3: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>,
            Sparkles: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
            MessageCircle: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
            Send: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>,
            Bot: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>,
            Settings: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.72l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            ArrowDown: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 5v14"/><path d="m19 12-7 7-7-7"/></svg>,
            Map: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21 3 6"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>,
            Search: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Gift: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.9 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></svg>,
            Store: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M22 7v3a2 2 0 0 1-2 2v0a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12v0a2 2 0 0 1-2-2V7"/></svg>,
            Utensils: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>,
            LocateFixed: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="2" x2="5" y1="12" y2="12"/><line x1="19" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="5"/><line x1="12" x2="12" y1="19" y2="22"/><circle cx="12" cy="12" r="7"/><circle cx="12" cy="12" r="3"/></svg>,
            Loader2: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            AlertTriangle: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
            Check: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="20 6 9 17 4 12"/></svg>,
            Navigation2: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 19 21 12 17 5 21 12 2"/></svg>,
            Camera: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            ShoppingBasket: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m5 11 4-7"/><path d="m19 11-4-7"/><path d="M2 11h20"/><path d="m3.5 11 1.6 7.4a2 2 0 0 0 2 1.6h9.8c.9 0 1.8-.7 2-1.6l1.7-7.4"/><path d="m9 11 1 9"/><path d="m4.5 11 .1 8.1"/><path d="m19.5 11-.1 8.1"/><path d="m15 11-1 9"/></svg>,
            Image: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            // 新增 CameraOff 圖示
            CameraOff: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="1" x2="23" y1="1" y2="23"/><path d="M7.74 18H4a2 2 0 0 1-2-2v-9a2 2 0 0 1 2-2h1.5l2.5-3h4"/><path d="M14.5 4h5a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-1"/><path d="M14 14.5a3 3 0 0 1-4.3-4.3"/></svg>,
            Newspaper: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/><path d="M18 14h-8"/><path d="M15 18h-5"/><path d="M10 6h8v4h-8V6Z"/></svg>,
            Mail: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>,
            UsersViewfinder: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="10" cy="10" r="7" /><path d="M21 21l-6-6" /><path d="M7 10h6" /><path d="M10 7v6" /></svg>,
            MapLocation: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20 10c0 6-8 8-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>, 
            Info: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            UpRightFromSquare: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><path d="M10 14 21 3"/></svg>,
            MoreHorizontal: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>,
            // 新增一個圖釘圖示來取代飛機圖示 (Pin)
            Pin: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.75 3.75-6 6"/><path d="M21 3 3 21l8-4 4-8Z"/><path d="m14 10 3 3"/></svg>,
            // 新增 Shield 圖示
            Shield: (props)=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/></svg>
        };

        const WeatherIcon = ({ type }) => {
            // 在明亮模式下，圖示顏色可以更鮮豔
            switch (type) {
                case 'sunny': return <Icons.Sun className="w-5 h-5 text-amber-600" />;
                case 'snowy': return <Icons.CloudSnow className="w-5 h-5 text-blue-300" />;
                case 'rainy': return <Icons.CloudRain className="w-5 h-5 text-blue-600" />;
                case 'cloudy': return <Icons.Cloud className="w-5 h-5 text-slate-500" />;
                default: return <Icons.CloudSnow className="w-5 h-5 text-slate-400" />;
            }
        };
        
        // --- Helper functions for time calculation (Moved to top and changed to function declarations) ---
        function deg2rad(deg) { return deg * (Math.PI/180) }
        
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1);
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); var d = R * c;
            return d.toFixed(1);
        }

        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        };

        function minutesToTimeStr(minutes) {
            let h = Math.floor(minutes / 60);
            let m = Math.floor(minutes % 60);
             h = h % 24; 
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        };

        // Parse "1.5 hr" or "30 min" to minutes
        function parseStayDuration(stayStr) {
             if (!stayStr || stayStr === '-') return 0;
             if (stayStr === 'Overnight') return 0;
             if (stayStr.includes('hr')) {
                 return parseFloat(stayStr) * 60;
             }
             if (stayStr.includes('min')) {
                 return parseInt(stayStr);
             }
             return 0;
        };
        
        // --- 全局主題配置 ---
        const THEMES = [
            { name: 'PinkMorandi', label: '粉色莫蘭迪', accent: '#FFC8DD', darkAccent: '#E07A5F' },
            { name: 'GreenMorandi', label: '綠色莫蘭迪', accent: '#A8B5A3', darkAccent: '#7D8B7E' }, 
            { name: 'DarkMorandi', label: '沉穩莫蘭迪', accent: '#E4C7C2', darkAccent: '#A0B7C6' },
        ];

        /* --- LLM API Function and Utils --- */

        /**
         * 呼叫 Google Gemini API 產生內容，支援文字、圖片輸入和 Google Search Grounding。
         */
        const generateGeminiContent = async (prompt, base64Image = null, useSearch = false) => {
            // 使用 Canvas 提供的全域 API Key 變數，若不存在則嘗試使用 localStorage
            const apiKey = typeof __gemini_api_key !== 'undefined' ? __gemini_api_key : localStorage.getItem('gemini_api_key') || "";
            
            if (!apiKey) {
                // 如果 API Key 缺失，拋出特定錯誤，讓 UI 可以提示使用者設定
                throw new Error('NO_API_KEY');
            }

            const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

            const contents = [{ role: "user", parts: [{ text: prompt }] }];

            // 處理多模態 (圖片) 輸入
            if (base64Image) {
                const mimeTypeMatch = base64Image.match(/data:(.*?);/);
                const mimeType = mimeTypeMatch ? mimeTypeMatch[1] : 'image/jpeg';
                const data = base64Image.split(',')[1] || base64Image;

                // 圖片放在文本之前
                contents[0].parts.unshift({
                    inlineData: {
                        mimeType: mimeType,
                        data: data
                    }
                });
            }

            const payload = {
                contents: contents,
                // 如果需要 Grounding，則加入 tools 屬性
                tools: useSearch ? [{ "google_search": {} }] : undefined,
            };

            // 簡單的指數退避重試機制
            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error('API Error Response:', errorBody);
                        if (response.status === 429 && i < maxRetries - 1) {
                            // 遇到 429 (Too Many Requests) 則重試
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            continue; 
                        }
                        throw new Error(`HTTP error! status: ${response.status} - ${errorBody.error?.message || 'Unknown error'}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        return text;
                    } else {
                        console.error("Gemini API returned no text:", result);
                        throw new Error("No content generated.");
                    }
                } catch (error) {
                    if (i === maxRetries - 1) throw error; 
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(res => setTimeout(res, delay));
                }
            }
        };

        /* --- GLOBAL CONSTANTS & HELPERS --- */
        
        // --- 貨幣轉換輔助資料 ---
        const CURRENCY_OPTIONS = [
            { code: 'JPY', symbol: '¥', name: '日幣' }, // 將 JPY 設為預設
            { code: 'TWD', symbol: 'NT$', name: '台幣' },
            { code: 'CNY', symbol: '¥', name: '人民幣' },
            { code: 'USD', symbol: '$', name: '美金' },
        ];

        // RAW DATA (KML IMPORTED - 2026寒假東京外郊親子行)
        // 匯入的數據結構
        const RAW_KML_DATA = [
            // Day 1: 成田與柏之葉園區 (1/20) - 使用 Pink Morandi
            { dayId: "day1", date: "01/20 (二)", title: "成田與柏之葉園區", themeColor: "bg-[#FFC8DD] text-[#333333]", spots: [ 
                { name: "成田國際機場", lat: 35.770178, lon: 140.3843215, desc: "抵達機場，準備開始旅程。", mapCode: "137 676 015*32" }, 
                { name: "取車櫃台", lat: 35.773998, lon: 140.3872634, desc: "機場二號航廈一樓北出口2號附近的租車櫃檯領取車輛。", mapCode: "137 558 393*14" },
                { name: "航空科學博物館", lat: 35.7403564, lon: 140.3977966, desc: "兒童票 250 日圓，成人 500 日圓。", mapCode: "137 558 393*14", ticket: { adult: 500, child: 250 } },
                { name: "Hard Off Kamagaya Michinobe", lat: 35.7504, lon: 140.001089, desc: "郊區二手店尋寶。", mapCode: "6 585 585*37" },
                { name: "Hard off Kashiwa Toyoshiki", lat: 35.864165, lon: 139.947972, desc: "第二站二手店尋寶。", mapCode: "18 099 274*62" },
                { name: "Hotel Torifito Kashiwanoha Campus", lat: 35.8917166, lon: 139.9497834, desc: "柏之葉園區飯店Check-in。", mapCode: "18 189 550*14", isHotel: true }
            ] },
            // Day 2: 大宮鐵道與購物 (1/21) - 使用 Green Morandi
            { dayId: "day2", date: "01/21 (三)", title: "大宮鐵道與購物", themeColor: "bg-[#A8B5A3] text-[#333333]", spots: [ 
                { name: "足立區生物園", lat: 35.792449, lon: 139.807227, desc: "親近自然的小型動物園。停車場 3 142 789*01。", mapCode: "3 142 789*01", ticket: { adult: 300, child: 150 } },
                { name: "Hard Off Soka Sezaki", lat: 35.8155163, lon: 139.8122316, desc: "Soka二手店。", mapCode: "3 232 445*72" },
                { name: "Hard Off .. Off House Omiya Higashi", lat: 35.9056813, lon: 139.6569344, desc: "大宮東區二手店。", mapCode: "3 544 246*31" },
                { name: "鐵道博物館", lat: 35.9214247, lon: 139.6179197, desc: "鐵道迷必訪，停車場 14 029 014*48。", mapCode: "14 029 014*48", ticket: { adult: 1300, child: 600 } },
                { name: "Hard Off / Off House Omiya Miyahara", lat: 35.9365868, lon: 139.6232865, desc: "宮原區 Hard Off。", mapCode: "3 630 875*33" },
                { name: "REF大宮 by Vessel Hotels", lat: 35.9062461, lon: 139.6270131, desc: "大宮車站附近Check-in。", mapCode: "3 540 318*44", isHotel: true }
            ] },
            // Day 3: 多摩與橫濱關內 (1/22) - 使用 Pink Morandi
            { dayId: "day3", date: "01/22 (四)", title: "多摩與橫濱關內", themeColor: "bg-[#FFC8DD] text-[#333333]", spots: [ 
                { name: "多摩六都科學館", lat: 35.7348225, lon: 139.5228711, desc: "五個圓形展廳，停車場 5 228 607*17。", mapCode: "5 228 607*17", ticket: { adult: 600, child: 200 } },
                { name: "Hard Off Hanakoganei", lat: 35.7337604, lon: 139.5124924, desc: "花小金井 Hard Off。", mapCode: "5 226 596*34" },
                { name: "鄉土之森博物館", lat: 35.6567725, lon: 139.4731485, desc: "古民居與博物館，停車場 2 852 191*55。", mapCode: "2 852 191*55", ticket: { adult: 300, child: 150 } },
                { name: "BOOKOFF SUPER BAZAAR Machida Central St. Main Store", lat: 35.5421243, lon: 139.4484443, desc: "町田Bookoff。2 429 575*44。", mapCode: "2 429 575*44" },
                { name: "HOTEL COMENTO YOKOHAMA KANNAI", lat: 35.4411763, lon: 139.6359113, desc: "橫濱關內Check-in，近中華街。", mapCode: "8 676 500*10", isHotel: true }
            ] },
            // Day 4: 橫濱/品川與舞濱 (1/23) - 使用 Green Morandi
            { dayId: "day4", date: "01/23 (五)", title: "橫濱/品川與舞濱", themeColor: "bg-[#A8B5A3] text-[#333333]", spots: [ 
                { name: "合味道紀念館 橫濱", lat: 35.4554755, lon: 139.6388669, desc: "製作屬於自己的杯麵。8 737 211*33。", mapCode: "8 737 211*33", ticket: { adult: 500, child: 300 } },
                { name: "三菱港未來技術館", lat: 35.4559216, lon: 139.6299412, desc: "科技展覽館。8 735 299*02。", mapCode: "8 735 299*02", ticket: { adult: 500, child: 200 } },
                { name: "BOOKOFF SUPER BAZAAR 409gou Kawasaki Minatocho Store", lat: 35.5333877, lon: 139.7179369, desc: "川崎 Bookoff 購物。", mapCode: "101 556*80" },
                { name: "品川水族館", lat: 35.588759, lon: 139.7371158, desc: "在都市裡享受水族樂趣。313 235*21。", mapCode: "313 235*21", ticket: { adult: 1350, child: 600 } },
                { name: "日和飯店舞濱", lat: 35.6462354, lon: 139.8970995, desc: "舞濱地區住宿，準備隔天玩樂。", mapCode: "6 213 121*27", isHotel: true }
            ] },
            // Day 5: 千葉與還車返台 (1/24) - 使用 Pink Morandi
            { dayId: "day5", date: "01/24 (六)", title: "千葉與還車返台", themeColor: "bg-[#FFC8DD] text-[#333333]", spots: [ 
                { name: "船橋安徒生公園", lat: 35.760458, lon: 140.0615382, desc: "廣闊的丹麥主題公園。停車場 6 652 238*73。", mapCode: "6 652 238*73", ticket: { adult: 900, child: 200 } },
                { name: "Hard Off / Off House / Hobby Off Tomisato Inter", lat: 35.7489725, lon: 140.3108172, desc: "最後一站二手店尋寶。", mapCode: "27 892 440*12" },
                { name: "ORIX還車", lat: 35.7741437, lon: 140.360417, desc: "成田機場附近 ORIX 營業所還車。", mapCode: "137 673 469*68" },
                { name: "成田國際機場", lat: 35.770178, lon: 140.3843215, desc: "搭機返回台北。", mapCode: "GPS" }
            ] }
        ];

        const FLIGHT_INFO = {
            outbound: { flight: "Fly", airline: "台北-成田", from: "台北 (TPE)", to: "成田 (NRT)", dep: "09:30", arr: "13:30", date: "01/20 (二)", duration: "4h 0m" },
            inbound: { flight: "Fly", airline: "成田-台北", from: "成田 (NRT)", to: "台北 (TPE)", dep: "17:30", arr: "20:00", date: "01/24 (六)", duration: "2h 30m" }
        };
        const HOTEL_INFO = [
            { day: "01/20", name: "Hotel Torifito Kashiwanoha Campus", location: "千葉柏之葉", desc: "柏之葉園區飯店", link: "https://www.google.com/maps/search/?api=1&query=Hotel+Torifito+Kashiwanoha+Campus", lat: 35.8917166, lon: 139.9497834 },
            { day: "01/21", name: "REF大宮 by Vessel Hotels", location: "埼玉大宮", desc: "大宮車站附近", link: "https://www.google.com/maps/search/?api=1&query=REF大宮+by+Vessel+Hotels", lat: 35.9062461, lon: 139.6270131 },
            { day: "01/22", name: "HOTEL COMENTO YOKOHAMA KANNAI", location: "橫濱關內", desc: "橫濱中華街附近", link: "https://www.google.com/maps/search/?api=1&query=HOTEL+COMENTO+YOKOHAMA+KANNAI", lat: 35.4411763, lon: 139.6359113 },
            { day: "01/23", name: "日和飯店舞濱", location: "千葉舞濱", desc: "東京迪士尼周邊", link: "https://www.google.com/maps/search/?api=1&query=日和飯店舞濱", lat: 35.6462354, lon: 139.8970995 }
        ];
        
        const RENTAL_INFO_LIST = [
            { label: "車輛", value: "租用五人座休旅車" },
            { label: "駕駛", value: "爸爸 (國際駕照/日文譯本已備)" },
            { label: "導航", value: "車機導航 / Google Maps" },
            { label: "ETC", value: "已租用 ETC 卡" },
            { label: "保險", value: "全險（免責補償制度）" },
            { label: "備註", value: "務必檢查雪胎狀況 (1月)" }
        ];
        
        const EXCHANGE_RATE = 1.0; 
        const STAY_OPTIONS = ["30 min", "1 hr", "1.5 hr", "2 hr", "2.5 hr", "3 hr", "4 hr", "5 hr", "Overnight", "-"];
        // 更新為莫蘭迪配色
        const EXPENSE_CATEGORIES = [
            { id: 'food', label: '飲食', Icon: Icons.Coffee, color: 'text-[var(--accent-pink-dark)]', bgColor: 'bg-[var(--accent-pink)]' }, 
            { id: 'shopping', label: '購物', Icon: Icons.ShoppingBag, color: 'text-[var(--accent-blue-dark)]', bgColor: 'bg-[var(--accent-blue)]' }, 
            { id: 'transport', label: '交通/停車', Icon: Icons.Car, color: 'text-[var(--accent-pink)]', bgColor: 'bg-[var(--accent-blue)]' }, 
            { id: 'hotel', label: '住宿', Icon: Icons.Hotel, color: 'text-[var(--accent-blue)]', bgColor: 'bg-[var(--accent-pink)]' }, 
            { id: 'ticket', label: '門票', Icon: Icons.Ticket, color: 'text-[var(--accent-pink-dark)]', bgColor: 'bg-[var(--accent-pink)]' },
            { id: 'fuel', label: '加油', Icon: Icons.Fuel, color: 'text-[var(--accent-blue-dark)]', bgColor: 'bg-[var(--accent-blue)]' },
            { id: 'other', label: '其他', Icon: Icons.MoreHorizontal, color: 'text-stone-500', bgColor: 'bg-stone-200' },
        ];

        /* --- COMPONENTS --- */

        // 1. Markdown 渲染組件
        const MarkdownRenderer = ({ content, className = '' }) => {
            const html = marked.parse(content || "");
            return <div className={`markdown-content ${className}`} dangerouslySetInnerHTML={{ __html: html }} />;
        };

        // 2. Daily Detail Modal Component
        const DailyDetailModal = ({ isOpen, onClose, dayData, allExpenses, spotTicketCounts, selectedCurrency, exchangeRate, tripData }) => {
            if (!isOpen || !dayData) return null;

            // Determine if showing whole trip details or just one day's
            const isTotalSummary = dayData.isTotalSummary;
            const filteredDays = isTotalSummary ? tripData : [dayData];

            // Flatten expenses for the relevant days
            const dayExpensesList = [];
            
            filteredDays.forEach(day => {
                const dayLabel = isTotalSummary ? day.date.split(' ')[0] : "";

                day.spots.forEach(spot => {
                    // 1. Manual Expenses
                    const spotExpenses = allExpenses[spot.id] || [];
                    spotExpenses.forEach(record => {
                        const dateMatch = record.note ? record.note.match(/^(\d{4}[-/]\d{2}[-/]\d{2}\s+\d{2}:\d{2})\s+(.*)$/) : null;
                        dayExpensesList.push({
                            type: 'manual',
                            spotName: `${dayLabel ? dayLabel + ' - ' : ''}${spot.name}`,
                            category: record.category,
                            amount: record.amount,
                            note: dateMatch ? dateMatch[2] : (record.note || "消費"),
                            date: dateMatch ? dateMatch[1] : null,
                            id: record.id
                        });
                    });

                    // 2. Ticket Expenses
                    if (spot.ticket) {
                        const counts = spotTicketCounts[spot.id] || { adult: 2, child: 2 };
                        const ticketCost = (spot.ticket.adult * counts.adult + spot.ticket.child * counts.child);
                        if (ticketCost > 0) {
                            dayExpensesList.push({
                                type: 'ticket',
                                spotName: `${dayLabel ? dayLabel + ' - ' : ''}${spot.name}`,
                                category: 'ticket',
                                amount: ticketCost,
                                note: `門票 (大${counts.adult} 小${counts.child})`,
                                id: `ticket-${spot.id}`
                            });
                        }
                    }
                });
            });

            const dayTotalBase = dayExpensesList.reduce((sum, item) => sum + item.amount, 0);
            const convertedTotal = (dayTotalBase * exchangeRate).toFixed(0);
            
            // 基礎貨幣為日幣 (JPY)
            const baseCurrency = CURRENCY_OPTIONS[0];

            return (
                <div className="fixed inset-0 bg-stone-900/80 backdrop-blur-sm flex items-center justify-center z-[130] p-4 animate-in fade-in duration-200" onClick={onClose}>
                    {/* 調整 Modal 背景色 */}
                    <div className="glass-panel rounded-2xl p-6 w-full max-w-sm shadow-2xl max-h-[85vh] flex flex-col bg-white/80 text-[var(--color-text)] border border-gray-200" onClick={e => e.stopPropagation()}>
                         <div className="flex justify-between items-center mb-4 border-b border-gray-300 pb-3">
                            <div>
                                <div className="text-xs font-bold text-gray-500 mb-1">{isTotalSummary ? "整個行程" : dayData.date}</div>
                                <h3 className="font-black text-xl text-[var(--color-text)]">{isTotalSummary ? "總花費明細" : dayData.title}</h3>
                            </div>
                            <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-200 text-gray-500 transition-colors"><Icons.X size={20}/></button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto space-y-3 pr-2">
                            {dayExpensesList.length === 0 ? (
                                <div className="text-center text-gray-400 py-8 flex flex-col items-center">
                                    <Icons.Wallet size={32} className="mb-2 opacity-50"/>
                                    <span>尚無花費紀錄</span>
                                </div>
                            ) : (
                                dayExpensesList
                                    .sort((a, b) => (a.date || a.spotName).localeCompare(b.date || b.spotName))
                                    .map((item, idx) => (
                                    <div key={item.id || idx} className="bg-white p-3 rounded-xl border border-gray-200 flex justify-between items-center shadow-sm">
                                        <div>
                                            {/* 使用 Accent-Blue */}
                                            <div className="text-xs text-[var(--accent-blue)] font-bold mb-0.5">{item.spotName}</div>
                                            <div className="flex flex-col">
                                                {item.date && <span className="text-[10px] text-gray-500 block">{item.date}</span>}
                                                <span className="text-sm font-bold text-[var(--color-text)]">{item.note}</span>
                                            </div>
                                        </div>
                                        <div className="font-mono font-bold text-[var(--color-text)] text-lg">{baseCurrency.symbol}{item.amount.toLocaleString()}</div>
                                    </div>
                                ))
                            )}
                        </div>

                        <div className="mt-4 pt-4 border-t border-gray-300 flex justify-between items-center">
                            <span className="text-sm font-bold text-gray-500 uppercase tracking-wider">總計 ({baseCurrency.code})</span>
                            {/* 使用 Accent-Pink-Dark */}
                            <span className="text-2xl font-mono font-black text-[var(--accent-pink-dark)]">{baseCurrency.symbol}{dayTotalBase.toLocaleString()}</span>
                        </div>
                        <div className="mt-2 flex justify-between items-center">
                            <span className="text-sm font-bold text-gray-500 uppercase tracking-wider">總計 ({selectedCurrency.code})</span>
                            {/* 使用 Accent-Blue-Dark */}
                            <span className="text-2xl font-mono font-black text-[var(--accent-blue-dark)]">{selectedCurrency.symbol} {convertedTotal.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. ApiKey Modal Component
        const ApiKeyModal = ({ isOpen, onClose }) => {
            const [key, setKey] = useState('');
            
            useEffect(() => {
                const storedKey = localStorage.getItem('gemini_api_key');
                if (storedKey) setKey(storedKey);
            }, [isOpen]);

            const handleSave = () => {
                localStorage.setItem('gemini_api_key', key.trim());
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-stone-800/80 backdrop-blur-sm flex items-center justify-center z-[120] p-4 animate-in fade-in duration-200">
                    <div className="glass-panel rounded-2xl p-6 w-full max-w-sm shadow-2xl bg-white/90 text-[var(--color-text)]">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="font-bold text-lg text-[var(--color-text)] flex items-center gap-2">
                                {/* 使用 Accent-Blue */}
                                <Icons.Settings size={20} className="text-[var(--accent-blue)]"/> 設定 AI 金鑰
                            </h3>
                            <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-200 text-gray-500 transition-colors">
                                <Icons.X size={20} />
                            </button>
                        </div>
                        <p className="text-xs text-gray-500 mb-4">
                            內建金鑰已啟用！若您有自己的 Key 可在此更換。
                        </p>
                        <input 
                            type="password" 
                            value={key} 
                            onChange={(e) => setKey(e.target.value)} 
                            placeholder="貼上 API Key (選填)"
                            /* 使用 Accent-Pink focus */
                            className="w-full bg-gray-100 rounded-lg p-3 text-sm mb-4 outline-none border border-gray-300 focus:ring-2 focus:ring-[var(--accent-pink)] text-[var(--color-text)]"
                        />
                        <div className="flex gap-2">
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" className="flex-1 text-center py-2 rounded-lg border border-gray-300 text-xs font-bold text-gray-600 hover:bg-gray-200">
                               取得 Key
                            </a>
                            {/* 使用 Accent-Blue 按鈕 */}
                            <button onClick={handleSave} className="flex-1 bg-[var(--accent-blue)] text-white py-2 rounded-lg text-sm font-bold hover:bg-[var(--accent-blue-dark)] shadow-md">
                                儲存
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Theme Selection Modal
        const ThemeSelectModal = ({ isOpen, onClose, setCurrentThemeIndex, currentThemeIndex }) => {
            if (!isOpen) return null;
            
            const handleSelectTheme = (index) => {
                setCurrentThemeIndex(index);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-stone-800/80 backdrop-blur-sm flex items-center justify-center z-[120] p-4 animate-in fade-in duration-200">
                    <div className="glass-panel rounded-2xl p-6 w-full max-w-sm shadow-2xl bg-white/90 text-[var(--color-text)]">
                        <h3 className="font-bold text-lg mb-4 text-[var(--color-text)] flex items-center gap-2">
                            <Icons.Sparkles size={20} className="text-[var(--accent-pink-dark)]"/> 選擇主題風格
                        </h3>
                        <div className="space-y-3">
                            {THEMES.map((theme, index) => (
                                <button
                                    key={theme.name}
                                    onClick={() => handleSelectTheme(index)}
                                    className={`w-full py-3 px-4 rounded-xl font-bold text-sm text-left theme-select-btn
                                        ${index === currentThemeIndex ? 'border-2 border-[var(--accent-pink-dark)] shadow-lg bg-[var(--accent-pink)]' : 'bg-gray-100 text-gray-700 border border-gray-300'}
                                        hover:shadow-md transition-shadow
                                    `}
                                >
                                    {theme.label} ({theme.name})
                                </button>
                            ))}
                        </div>
                        <button onClick={onClose} className="mt-4 w-full py-2 text-gray-500 hover:text-[var(--color-text)] border border-gray-300 rounded-xl hover:bg-gray-100">
                            取消
                        </button>
                    </div>
                </div>
            );
        };

        // 4. ExpenseModal
        const ExpenseModal = ({ isOpen, onClose, currentEditingSpot, expenseForm, setExpenseForm, handleImageUpload, pendingReceipts, togglePendingReceipt, removePendingReceipt, saveExpense, expenses, deleteExpense, isAnalyzingReceipt, quotaStatus }) => {
            if (!isOpen || !currentEditingSpot) return null;
            
            // 使用防禦性程式碼確保 pendingReceipts 是陣列
            const safePendingReceipts = pendingReceipts || [];
            // 基礎貨幣為 JPY
            const baseCurrency = CURRENCY_OPTIONS[0];

            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[100] p-4 backdrop-blur-sm">
                    {/* 調整 Modal 背景色 */}
                    <div className="glass-panel rounded-2xl p-6 w-full max-w-sm bg-white/90 text-[var(--color-text)] border border-gray-200 flex flex-col max-h-[85vh]">
                        <h3 className="font-bold text-lg mb-4 text-[var(--color-text)] shrink-0">{currentEditingSpot.name}</h3>
                        
                        <div className="flex-1 overflow-y-auto pr-1 -mr-1">
                            <input type="text" value={expenseForm.note} onChange={e => setExpenseForm({...expenseForm, note: e.target.value})} className="w-full bg-gray-100 p-3 rounded-xl mb-4 text-sm text-[var(--color-text)] border border-gray-300 outline-none focus:border-[var(--accent-pink)]" placeholder="備註/摘要 (例如: 商店名)" />
                            <div className="relative mb-4">
                                {/* 使用 Accent-Pink focus */}
                                <input type="number" value={expenseForm.amount} onChange={e => setExpenseForm({...expenseForm, amount: e.target.value})} className="w-full bg-gray-100 p-3 rounded-xl text-xl font-mono text-[var(--color-text)] border border-gray-300 outline-none focus:border-[var(--accent-pink)] pr-32" placeholder={`金額 (${baseCurrency.code})`} autoFocus />
                                <div className="absolute right-12 top-1/2 -translate-y-1/2 flex items-center gap-2 z-10 pointer-events-none">
                                    <div className="relative pointer-events-auto"><input type="file" accept="image/*" id="gallery-upload" className="hidden" multiple onChange={handleImageUpload}/><label htmlFor="gallery-upload" className={`p-1.5 rounded-lg cursor-pointer flex items-center justify-center transition-colors ${isAnalyzingReceipt ? 'text-gray-400 cursor-not-allowed' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-100'}`}><Icons.Image size={20} /></label></div>
                                    {/* 使用 Accent-Pink-Dark pulse */}
                                    <div className="relative pointer-events-auto"><input type="file" accept="image/*" capture="environment" id="camera-upload" className="hidden" onChange={handleImageUpload}/><label htmlFor="camera-upload" className={`p-1.5 rounded-lg cursor-pointer flex items-center justify-center transition-colors ${isAnalyzingReceipt ? 'text-[var(--accent-pink-dark)] animate-pulse' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-100'}`}>{isAnalyzingReceipt ? <Icons.Loader2 size={20} className="animate-spin" /> : <Icons.Camera size={20} />}</label></div>
                                </div>
                            </div>
                            {safePendingReceipts.length > 0 && (
                                <div className="mb-4 space-y-2">
                                    {/* 使用 Accent-Blue */}
                                    <div className="flex justify-between items-center"><div className="text-xs font-bold text-[var(--accent-blue)] flex items-center gap-1"><Icons.Sparkles size={12} className="text-[var(--accent-blue)]"/> AI 辨識結果 ({safePendingReceipts.filter(p=>p.isChecked).length})</div><div className={`text-[10px] font-bold px-2 py-0.5 rounded-full flex items-center gap-1 ${quotaStatus.type === 'error' ? 'bg-red-500/20 text-red-600' : 'bg-green-500/20 text-green-600'}`}><div className={`w-1.5 h-1.5 rounded-full ${quotaStatus.type === 'error' ? 'bg-red-500 animate-pulse' : 'bg-green-500'}`}></div>{quotaStatus.text}</div></div>
                                    <div className="bg-gray-100 rounded-xl p-2 border border-[var(--accent-blue)]/30 space-y-2 max-h-40 overflow-y-auto">
                                        {safePendingReceipts.map(item => (
                                            <div key={item.id} className={`flex items-center gap-3 p-2 rounded-lg transition-colors ${item.isChecked ? 'bg-[var(--accent-blue)]/10' : 'opacity-50'}`}>
                                                <input type="checkbox" checked={item.isChecked} onChange={() => togglePendingReceipt(item.id)} className="w-4 h-4 rounded border-gray-400 accent-[var(--accent-blue)] cursor-pointer shrink-0" />
                                                <div className="flex-1 min-w-0">{item.isAnalyzing ? (<div className="flex items-center gap-2 text-xs text-gray-500"><Icons.Loader2 size={12} className="animate-spin"/> {item.note}</div>) : (<><div className={`font-bold text-sm truncate ${item.note.includes('額度') || item.note.includes('失敗') ? 'text-red-500' : 'text-[var(--color-text)]'}`}>{item.note || '未命名'}</div>{item.amount > 0 && <div className="text-xs text-[var(--accent-blue)] font-mono">{baseCurrency.symbol}{item.amount}</div>}</>)}</div>
                                                <button onClick={() => removePendingReceipt(item.id)} className="text-gray-500 hover:text-red-500 p-1"><Icons.X size={14} /></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            <div className="pt-4 border-t border-dashed border-gray-300">
                                <div className="text-xs font-bold text-gray-500 mb-3">歷史紀錄</div>
                                <div className="space-y-2">
                                    {(expenses[currentEditingSpot.id] || []).map(record => {
                                        const dateMatch = record.note ? record.note.match(/^(\d{4}[-/]\d{2}[-/]\d{2}\s+\d{2}:\d{2})\s+(.*)$/) : null;
                                        return (<div key={record.id} className="flex justify-between items-center text-sm bg-gray-100 p-3 rounded-xl border border-gray-300 shadow-sm"><div className="flex flex-col">{dateMatch ? <><span className="text-[10px] text-gray-500 block mb-0.5">{dateMatch[1]}</span><span className="font-bold text-[var(--color-text)] text-base">{dateMatch[2]}</span></> : <span className="font-bold text-[var(--color-text)]">{record.note || "消費"}</span>}</div><div className="flex items-center gap-3"><span className="font-mono font-bold text-[var(--color-text)]">{baseCurrency.symbol}{record.amount}</span><button onClick={() => deleteExpense(currentEditingSpot.id, record.id)} className="text-gray-500 hover:text-red-500"><Icons.X size={16} /></button></div></div>);
                                    })}
                                </div>
                            </div>
                        </div>
                        <div className="flex gap-2 mt-4 shrink-0"><button onClick={onClose} className="flex-1 py-3 text-gray-500 hover:text-[var(--color-text)]">取消</button>
                        {/* 使用 Accent-Pink 儲存按鈕 */}
                        <button 
                            onClick={saveExpense} 
                            className="flex-1 bg-[var(--accent-pink)] text-[var(--color-text)] rounded-xl font-bold py-3 shadow-[0_4px_0px_var(--accent-pink-dark)] active:translate-y-[2px] active:shadow-none"
                        >
                            {((safePendingReceipts).filter(p => p.isChecked).length > 0 || expenseForm.amount) 
                                ? `儲存 (${((safePendingReceipts).filter(p => p.isChecked).length) + (expenseForm.amount ? 1 : 0)}筆)` 
                                : '儲存'}
                        </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 5. EmailModal
        const EmailModal = ({ isOpen, onClose, emailInput, setEmailInput, handleSendEmail, isSendingEmail, tripTitle }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-stone-900/80 backdrop-blur-sm flex items-center justify-center z-[130] p-4 animate-in fade-in duration-200">
                    <div className="glass-panel rounded-2xl p-6 w-full max-w-sm shadow-2xl bg-white/90 text-[var(--color-text)] border border-gray-200">
                        {/* 使用 Accent-Blue */}
                        <h3 className="font-bold text-lg mb-2 text-[var(--color-text)] flex items-center gap-2"><Icons.Mail size={20} className="text-[var(--accent-blue)]" /> 寄送花費報表</h3>
                        <p className="text-xs text-gray-500 mb-4">將本次旅程的所有花費明細製作成表格，寄送到您的信箱。</p>
                        <label className="block text-xs font-bold text-gray-600 mb-1">收件人信箱</label>
                        {/* 使用 Accent-Blue focus */}
                        <input type="email" value={emailInput} onChange={(e) => setEmailInput(e.target.value)} placeholder="your@email.com" className="w-full bg-gray-100 p-3 rounded-xl mb-6 text-sm text-[var(--color-text)] border border-gray-300 outline-none focus:border-[var(--accent-blue)]" />
                        <div className="flex gap-2"><button onClick={onClose} className="flex-1 py-2 text-gray-500 hover:text-[var(--color-text)] transition-colors" disabled={isSendingEmail}>取消</button>
                        {/* 使用 Accent-Blue 按鈕 */}
                        <button onClick={handleSendEmail} className="flex-1 bg-[var(--accent-blue)] text-white rounded-xl font-bold py-2 shadow-lg hover:bg-[var(--accent-blue-dark)] transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2" disabled={isSendingEmail}>{isSendingEmail ? <><Icons.Loader2 size={16} className="animate-spin" /> 發送中...</> : '確認發送'}</button></div>
                    </div>
                </div>
            );
        };

        // 6. CurrencySwitcher Component
        const CurrencySwitcher = ({ selectedCurrency, exchangeRate, isRateLoading, rateError, setSelectedCurrency, baseCurrencyCode }) => {
            
            const handleCurrencyChange = (e) => {
                setSelectedCurrency(CURRENCY_OPTIONS.find(c => c.code === e.target.value));
            };

            return (
                <div className="flex flex-col items-end gap-1">
                    <div className="bg-white p-2 rounded-xl shadow-[0_4px_10px_rgba(0,0,0,0.1)] border border-gray-200 hover:bg-gray-100 transition-all group relative">
                        <select 
                            value={selectedCurrency.code}
                            onChange={handleCurrencyChange}
                            className={`bg-transparent outline-none cursor-pointer text-[var(--color-text)] text-sm font-bold w-16 appearance-none pr-6 focus:ring-0 ${isRateLoading ? 'animate-pulse text-red-500' : ''}`}
                            disabled={isRateLoading}
                        >
                            {CURRENCY_OPTIONS.map(c => (
                                <option key={c.code} value={c.code} className="bg-white">{c.code}</option>
                            ))}
                        </select>
                        {/* 使用 Accent-Pink hover */}
                        <Icons.ArrowDown size={14} className="absolute right-1 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400 group-hover:text-[var(--accent-pink)] transition-colors"/>
                    </div>
                    {/* 手機上隱藏匯率細節，只顯示選擇框 */}
                    <div className="text-right text-[10px] font-bold text-gray-500 uppercase bg-white px-2 py-0.5 rounded-full border border-gray-300 w-fit shadow-sm hidden md:block">
                        {isRateLoading ? (
                            <span className="flex items-center text-[var(--accent-blue)]">
                                <Icons.Loader2 className="w-3 h-3 mr-1 animate-spin" /> 查詢中...
                            </span>
                        ) : rateError ? (
                            <span className="text-red-500 flex items-center">
                                <Icons.AlertTriangle className="w-3 h-3 mr-1"/> 失敗
                            </span>
                        ) : (
                            `1 ${baseCurrencyCode} ≈ ${exchangeRate.toFixed(4)} ${selectedCurrency.code}`
                        )}
                    </div>
                </div>
            );
        };


        // 7. ItineraryTab
        const ItineraryTab = ({ tripData, selectedDay, setSelectedDay, dayStartTimes, handleDayStartTimeChange, handleDepartureToggle, handleTransportToggle, handleStayChangeNew, openExpenseModal, transportModes, expenses, getTicketCounts, STAY_OPTIONS }) => {
            const filteredTripData = selectedDay === 'all' ? tripData : tripData.filter(day => day.dayId === selectedDay);
            return (
                <div className="animate-in fade-in slide-in-from-bottom-6 duration-700">
                    {/* 調整背景色 */}
                    <div className="flex flex-wrap gap-3 mb-8 justify-center sticky top-24 z-40 py-2 bg-[var(--bg-main)]/90 backdrop-blur rounded-2xl border border-gray-200 shadow-lg">
                        <button onClick={() => setSelectedDay('all')} className={`px-5 py-2 rounded-xl text-sm font-bold border transition-all shadow-sm ${selectedDay === 'all' ? 'bg-white text-[var(--accent-pink-dark)] border-[var(--accent-pink-dark)]' : 'bg-white text-gray-600 border-gray-300 hover:border-[var(--accent-pink)]'}`}>全部</button>
                        {tripData.map(day => (<button key={day.dayId} onClick={() => setSelectedDay(day.dayId)} className={`px-5 py-2 rounded-xl text-sm font-bold border transition-all shadow-sm ${selectedDay === day.dayId ? `${day.themeColor} border-transparent shadow-md` : 'bg-white text-gray-600 border-gray-300 hover:border-[var(--accent-pink)]'}`}>{day.date.split(' ')[0]}</button>))}
                    </div>
                    <div className="space-y-12">
                        {filteredTripData.map((day) => {
                            // 基礎貨幣為 JPY
                            const baseCurrency = CURRENCY_OPTIONS[0];
                            return (
                            <div key={day.dayId} className="relative">
                                <div className="flex items-center gap-4 mb-6">
                                    {/* 調整為莫蘭迪色 Day 區塊 */}
                                    <div className={`${day.themeColor} w-16 h-16 rounded-2xl flex flex-col items-center justify-center text-[var(--color-text)] shadow-[0_4px_10px_rgba(0,0,0,0.1)] border-2 border-white -rotate-2`}>
                                        <span className="text-xs font-bold uppercase">Day</span>
                                        <span className="text-2xl font-black leading-none">{day.dayId.replace('day','')}</span>
                                    </div>
                                    <div className="glass-panel px-6 py-2 rounded-r-2xl rounded-bl-2xl shadow-sm border border-gray-200 flex-1">
                                        <div className="text-2xl font-black text-[var(--color-text)]">{day.date}</div>
                                        <div className="text-lg font-bold text-gray-500">{day.title}</div>
                                    </div>
                                </div>
                                <div className="space-y-8 pl-4 border-l-4 border-dotted border-gray-300 ml-8">
                                    {day.spots.map((spot, index) => {
                                        const spotExpenses = expenses[spot.id] || [];
                                        const spotTotal = spotExpenses.reduce((sum, r) => sum + (r.amount || 0), 0);
                                        const counts = getTicketCounts(spot.id);
                                        const ticketTotal = spot.ticket ? (spot.ticket.adult * counts.adult + spot.ticket.child * counts.child) : 0;
                                        const totalCostDisplay = spotTotal + ticketTotal;
                                        return (
                                            <div key={spot.id} className="relative group">
                                                {/* 調整圓點顏色：使用 Accent-Pink 邊框 */}
                                                <div className="absolute -left-[29px] top-6 w-5 h-5 rounded-full bg-[var(--bg-main)] border-4 border-[var(--accent-pink)] z-10 shadow-[0_0_10px_var(--accent-pink)]/50"></div>
                                                <div className="glass-panel rounded-[2rem] p-6 md:p-8 shadow-lg border border-gray-200 transition-all hover:-translate-y-1 hover:border-[var(--accent-pink)]/50 hover:shadow-[0_10px_30px_rgba(0,0,0,0.15)] bg-white/90">
                                                    <div className="flex flex-col md:flex-row justify-between items-start gap-4 mb-4">
                                                        <div className="flex-1 w-full">
                                                            <div className="flex items-center justify-between mb-3">
                                                                {/* 使用 Accent-Blue 時間區塊 */}
                                                                <div className="relative group/time flex items-center gap-2 bg-gray-100 rounded-xl px-3 py-1 border border-gray-300 shadow-sm text-[var(--accent-blue)] transform -rotate-1 hover:scale-105 transition-all w-fit">
                                                                    {index === 0 ? <><span className="text-sm font-bold font-mono text-[var(--color-text)] shrink-0">抵達</span><input type="time" value={dayStartTimes[day.dayId] || "09:00"} onChange={(e) => handleDayStartTimeChange(day.dayId, e.target.value)} className="bg-white text-[var(--color-text)] rounded px-2 py-0.5 outline-none font-bold text-sm font-mono border border-gray-300 focus:border-[var(--accent-pink)]" /></> : <><span className="text-sm font-bold font-mono text-[var(--accent-pink-dark)] shrink-0">抵達</span><span className="text-lg font-bold font-mono text-[var(--accent-pink-dark)]">{spot.time}</span></>}
                                                                </div>
                                                                {/* 確認動身按鈕：已動身 (Accent-Blue), 未動身 (Accent-Pink) */}
                                                                <button onClick={() => handleDepartureToggle(spot.id)} className={`flex items-center gap-2 px-4 py-2 rounded-full font-bold text-xs transition-all shadow-md active:scale-95 ${spot.isDeparted ? 'bg-[var(--accent-blue)]/20 text-[var(--accent-blue)] border border-[var(--accent-blue)]' : 'bg-[var(--accent-pink)] text-[var(--color-text)] hover:bg-[var(--accent-pink-dark)]/50'}`}>{spot.isDeparted ? <><Icons.Check size={14} />已動身 {spot.actualDepTime}</> : <><Icons.Navigation2 size={14} />確認動身</>}</button>
                                                            </div>
                                                            <h3 className="text-2xl font-black text-[var(--color-text)] mb-2">{spot.name}</h3>
                                                            <div className="flex items-center gap-4 text-sm font-bold text-gray-500 mb-4 bg-gray-100 w-fit px-3 py-1 rounded-lg border border-gray-300">
                                                                <span className="flex items-center gap-1"><WeatherIcon type={spot.weather} /> {spot.temp}</span><span className="w-1.5 h-1.5 rounded-full bg-gray-400"></span><span className="flex items-center gap-1">停留 <select value={spot.stay} onChange={(e) => handleStayChangeNew(spot.id, e.target.value)} className="bg-transparent outline-none cursor-pointer border-b border-dashed border-gray-500 hover:border-[var(--accent-pink)] hover:text-[var(--accent-pink-dark)] transition-colors ml-1 appearance-none text-center">{STAY_OPTIONS.map(opt => <option key={opt} value={opt} className="bg-white text-[var(--color-text)]">{opt}</option>)}</select></span>
                                                            </div>
                                                            <div className="text-lg font-bold text-gray-700 leading-relaxed mb-6 relative"><span className="text-4xl absolute -top-4 -left-2 text-gray-300 z-0">“</span><p className="relative z-10">{spot.desc}</p></div>
                                                            <div className="flex flex-wrap gap-2 mb-4">
                                                                {/* 使用 Accent-Blue 圖示 */}
                                                                <div className="bg-gray-100 border border-gray-300 px-3 py-1.5 rounded-xl text-xs font-bold text-gray-500 flex items-center gap-1"><Icons.MapPin size={12} className="text-[var(--accent-blue)]" /> {spot.mapcodeLabel}: <span className="font-mono text-[var(--color-text)]">{spot.mapcodeDisplay}</span></div>
                                                                {/* 使用 Accent-Blue 按鈕 */}
                                                                <a href={spot.gmapLink} target="_blank" rel="noreferrer" className="bg-[var(--accent-blue)] text-white hover:bg-[var(--accent-blue-dark)] px-3 py-1.5 rounded-xl text-xs font-bold transition-colors flex items-center gap-1 shadow-[0_2px_10px_var(--accent-blue)]/30 active:translate-y-[1px] active:shadow-none">打開地圖 <Icons.ExternalLink size={10} className="text-white"/></a>
                                                            </div>
                                                        </div>
                                                        {/* 使用 Accent-Pink 按鈕 */}
                                                        <button onClick={() => openExpenseModal(spot)} className="self-start md:self-center bg-[var(--accent-pink)] text-[var(--color-text)] p-4 rounded-2xl transition-all shadow-[0_4px_15px_var(--accent-pink)]/30 hover:-translate-y-1 hover:bg-[var(--accent-pink-dark)]/50 active:translate-y-0 border border-white/5"><Icons.Wallet size={24} strokeWidth={2.5} className="text-[var(--accent-pink-dark)]"/></button>
                                                    </div>
                                                    {(spotTotal > 0 || ticketTotal > 0) && (<div className="mt-4 pt-4 border-t border-dashed border-gray-300 flex justify-end items-center gap-2"><span className="text-xs font-bold text-gray-500 uppercase bg-white px-2 py-0.5 rounded border border-gray-300">Estimated Total</span>{/* 使用 Accent-Pink-Dark */}
                                                    <span className="text-xl font-mono font-black text-[var(--accent-pink-dark)]">{baseCurrency.symbol}{totalCostDisplay.toLocaleString()}</span></div>)}
                                                </div>
                                                {spot.nextStop && (
                                                    <div className="relative flex flex-col items-center my-6 gap-3">
                                                        <div className="absolute top-0 bottom-0 w-0.5 bg-gray-300 -z-10"></div>
                                                        <div className="bg-white border border-gray-300 px-4 py-2 rounded-2xl flex flex-col items-center gap-1 text-xs text-gray-500 shadow-lg z-10"><span className="font-bold text-[var(--color-text)]">前往：{spot.nextStop.name}</span><div className="flex items-center gap-3"><span className="font-mono text-[var(--accent-blue)]">{spot.nextStop.distance}</span><span className="w-px h-3 bg-gray-400"></span><button onClick={() => handleTransportToggle(spot.id)} className="flex items-center gap-1 hover:text-[var(--accent-blue)] transition-colors font-bold">{transportModes[spot.id] === 'walk' ? <><Icons.Footprints size={12} className="text-[var(--accent-pink)]"/> {spot.nextStop.walkTime}</> : <><Icons.Car size={12} className="text-[var(--accent-blue)]"/> {spot.nextStop.driveTime}</>}</button></div></div>
                                                        {/* 使用 Accent-Blue 導航按鈕 */}
                                                        <a href={spot.nextStop.navLink} target="_blank" rel="noreferrer" className="bg-[var(--accent-blue)] text-white px-4 py-2 rounded-full text-xs font-bold shadow-[0_0_15px_var(--accent-blue)]/40 hover:bg-[var(--accent-blue-dark)] hover:scale-105 transition-all flex items-center gap-1 z-10 border border-white/10"><Icons.Navigation size={14} className="text-white"/> Google 導航</a>
                                                        <div className="text-gray-400 mt-1"><Icons.ArrowDown size={20} /></div>
                                                        <div className="text-xs text-gray-500 mt-1">預計抵達下一站: <span className="text-[var(--accent-blue)] font-bold font-mono">{spot.departureTime}</span> 後 + {transportModes[spot.id] === 'walk' ? spot.nextStop.walkTime : spot.nextStop.driveTime}</div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )})}
                    </div>
                </div>
            );
        };

        // 8. InfoTab
        const InfoTab = () => {
            return (
                <div className="animate-in fade-in slide-in-from-bottom-6 duration-700 space-y-8">
                    <div className="glass-panel rounded-2xl border border-gray-200 shadow-2xl overflow-hidden">
                        {/* 使用 Accent-Blue 標題 */}
                        <div className="p-6 md:p-8 border-b border-gray-300 flex items-center gap-4"><div className="bg-[var(--accent-blue)]/10 p-3 rounded-xl border border-[var(--accent-blue)]/20 shadow-[0_0_15px_var(--accent-blue)]/15"><Icons.Navigation size={28} className="text-[var(--accent-blue)]" /></div><div><h1 className="text-2xl font-bold text-[var(--color-text)] tracking-wide">實用導航 & 周邊機能</h1><p className="text-gray-500 text-sm mt-1">一鍵搜尋周邊生活機能</p></div></div>
                        <div className="p-6 md:p-8 bg-white/90">
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                                {NAV_BUTTONS_NEW.map((btn, index) => (
                                    <button key={index} onClick={() => { const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(btn.query)}`; window.open(url, '_blank'); }} className="group relative flex items-center p-4 rounded-xl bg-gray-100/50 border border-gray-300 hover:border-[var(--accent-blue)]/50 hover:bg-gray-100 transition-all duration-300 text-left shadow-sm">
                                        <div className="flex-shrink-0 w-12 h-12 rounded-lg bg-gray-200/50 flex items-center justify-center text-gray-600 group-hover:text-[var(--accent-blue)] group-hover:scale-110 group-hover:bg-gray-200 transition-all duration-300"><btn.icon size={24} /></div>
                                        <div className="ml-4 flex-grow"><h3 className="text-[var(--color-text)] font-medium group-hover:text-black transition-colors">{btn.title}</h3><p className="text-xs text-gray-500 mt-0.5 group-hover:text-[var(--accent-blue)]/80 transition-colors flex items-center gap-1">開啟地圖 <Icons.MapPin size={10} /></p></div>
                                        <div className="opacity-0 group-hover:opacity-100 transition-opacity absolute right-3 top-3 text-gray-400"><Icons.ExternalLink size={14} /></div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                    
                    <div className="glass-panel rounded-[2rem] p-8 shadow-lg border border-gray-200">
                        {/* 使用 Accent-Blue 標題 */}
                        <h3 className="text-2xl font-black text-[var(--color-text)] mb-6 flex items-center gap-2"><span className="bg-[var(--accent-blue)] p-2 rounded-xl text-white rotate-3 shadow-lg"><Icons.Car size={20} /></span>車程預估</h3>
                        <div className="space-y-6">
                            {/* 使用 Accent-Blue 淺藍色塊 (去程) */}
                            <div className="bg-[var(--accent-blue)]/30 p-6 rounded-3xl border border-[var(--accent-blue)]/50 relative overflow-hidden backdrop-blur-sm">
                                <div className="flex justify-between items-center mb-4 relative z-10"><span className="bg-[var(--accent-blue)] text-white text-xs font-black px-3 py-1 rounded-full shadow-md">去程</span><span className="font-bold text-[var(--color-text)]">{FLIGHT_INFO.outbound.date}</span></div>
                                <div className="flex justify-between items-center text-center relative z-10"><div><div className="text-4xl font-black text-[var(--color-text)]">{FLIGHT_INFO.outbound.dep}</div><div className="text-sm font-bold text-gray-500">{FLIGHT_INFO.outbound.from}</div></div><div className="flex-1 px-4 flex flex-col items-center"><div className="text-xs font-bold text-gray-500 mb-1">{FLIGHT_INFO.outbound.duration}</div><div className="w-full border-t border-dashed border-gray-400 relative my-2"><Icons.Plane size={16} className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[var(--accent-pink)] bg-[var(--accent-blue)]/30 px-1 rounded-full" /></div><div className="text-xs font-bold text-[var(--accent-pink)] mt-1">{FLIGHT_INFO.outbound.flight}</div></div><div><div className="text-4xl font-black text-[var(--color-text)]">{FLIGHT_INFO.outbound.arr}</div><div className="text-sm font-bold text-gray-500">{FLIGHT_INFO.outbound.to}</div></div></div>
                            </div>
                            {/* 使用 Accent-Pink 淺粉色塊 (回程) */}
                            <div className="bg-[var(--accent-pink)]/30 p-6 rounded-3xl border border-[var(--accent-pink)]/50 relative overflow-hidden backdrop-blur-sm">
                                <div className="flex justify-between items-center mb-4 relative z-10"><span className="bg-[var(--accent-pink)] text-[var(--color-text)] text-xs font-black px-3 py-1 rounded-full shadow-md">回程</span><span className="font-bold text-[var(--color-text)]">{FLIGHT_INFO.inbound.date}</span></div>
                                <div className="flex justify-between items-center text-center relative z-10"><div><div className="text-4xl font-black text-[var(--color-text)]">{FLIGHT_INFO.inbound.dep}</div><div className="text-sm font-bold text-gray-500">{FLIGHT_INFO.inbound.from}</div></div><div className="flex-1 px-4 flex flex-col items-center"><div className="text-xs font-bold text-gray-500 mb-1">{FLIGHT_INFO.inbound.duration}</div><div className="w-full border-t border-dashed border-gray-400 relative my-2"><Icons.Plane size={16} className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[var(--accent-pink-dark)] bg-[var(--accent-pink)]/30 px-1 rounded-full" /></div><div className="text-xs font-bold text-[var(--accent-pink-dark)] mt-1">{FLIGHT_INFO.inbound.flight}</div></div><div><div className="text-4xl font-black text-[var(--color-text)]">{FLIGHT_INFO.inbound.arr}</div><div className="text-sm font-bold text-gray-500">{FLIGHT_INFO.inbound.to}</div></div></div>
                            </div>
                        </div>
                    </div>
                    {/* 🚗 Rental Car Info Block (使用 Accent-Blue) */}
                    <div className="glass-panel rounded-[2rem] p-8 shadow-lg border border-gray-200">
                        <h3 className="text-2xl font-black text-[var(--color-text)] mb-6 flex items-center gap-2"><span className="bg-[var(--accent-blue)] p-2 rounded-xl text-white rotate-1 shadow-lg"><Icons.Car size={20} /></span>行車檢查清單<span className="text-xs bg-gray-300 text-gray-700 px-2 py-1 rounded ml-2">出發前確認</span></h3>
                        <div className="bg-gray-100 p-6 rounded-2xl border border-gray-300 font-mono text-sm leading-relaxed text-gray-700"><ul className="space-y-2 list-disc list-inside">{RENTAL_INFO_LIST.map((item, idx) => (<li key={idx} className="break-words"><span className="font-bold text-[var(--color-text)]">{item.label}：</span>{item.value}</li>))}</ul></div>
                    </div>
                    <div className="glass-panel rounded-[2rem] p-8 shadow-lg border border-gray-200">
                        {/* 使用 Accent-Pink 標題 */}
                        <h3 className="text-2xl font-black text-[var(--color-text)] mb-6 flex items-center gap-2"><span className="bg-[var(--accent-pink)] p-2 rounded-xl text-[var(--accent-pink-dark)] -rotate-2 shadow-lg"><Icons.Hotel size={20} /></span>住宿安排</h3>
                        <div className="grid gap-4">{HOTEL_INFO.map((hotel, idx) => (<div key={idx} className="flex gap-4 p-4 rounded-2xl hover:bg-gray-100 transition-colors border border-gray-200 hover:border-[var(--accent-pink)]/50 group bg-white/90"><div className="bg-gray-200 text-[var(--color-text)] font-bold text-sm h-10 w-12 rounded-xl flex items-center justify-center shrink-0 shadow-md group-hover:bg-[var(--accent-pink)] group-hover:text-[var(--accent-pink-dark)] transition-colors">{hotel.day}</div><div className="flex-1"><h4 className="font-bold text-lg text-[var(--color-text)]">{hotel.name}</h4><p className="text-sm font-bold text-gray-500 mt-1">{hotel.location} • {hotel.desc}</p></div><a href={hotel.link} target="_blank" rel="noreferrer" className="self-center bg-gray-100 border border-gray-300 p-2 rounded-full text-gray-500 hover:text-[var(--accent-pink)] hover:border-[var(--accent-pink)] transition-colors"><Icons.Navigation size={20} /></a></div>))}</div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="glass-panel rounded-[2rem] p-6 shadow-lg border border-gray-200"><h3 className="text-lg font-black text-[var(--color-text)] mb-4">緊急聯絡</h3><div className="space-y-4"><a href="tel:119" className="flex items-center justify-between p-4 bg-[#FEE2E2]/50 rounded-2xl text-red-600 font-bold hover:bg-[#FEE2E2] transition-colors border border-red-300"><span>🚑 救護車/火警</span><span className="2xl font-black">119</span></a><a href="tel:110" className="flex items-center justify-between p-4 bg-[#DBEAFE]/50 rounded-2xl text-blue-600 font-bold hover:bg-[#DBEAFE] transition-colors border border-blue-300"><span>🚓 警察局</span><span className="2xl font-black">110</span></a></div></div>
                        <div className="glass-panel rounded-[2rem] p-6 shadow-lg border border-gray-200"><h3 className="text-lg font-black text-[var(--color-text)] mb-4">實用連結</h3><div className="space-y-3"><a href="https://www.google.com/maps" target="_blank" rel="noreferrer" className="block w-full text-center py-3 bg-gray-200 border border-gray-300 text-gray-700 font-bold rounded-xl hover:bg-gray-300 active:bg-gray-400 transition-colors">Google Maps</a><a href="https://www.cwa.gov.tw/V8/C/" target="_blank" rel="noreferrer" className="block w-full text-center py-3 bg-blue-100 border border-blue-300 text-blue-700 font-bold rounded-xl hover:bg-blue-200 active:bg-blue-300 transition-colors">中央氣象署</a></div></div>
                    </div>
                </div>
            );
        };

        // 9. StatsTab
        const StatsTab = ({ dailyStats, handleOpenDailyDetail, handleOpenEmailClick, stats, selectedCurrency, exchangeRate, setSelectedCurrency, tripData, isRateLoading, rateError }) => { 
            const convertedTotal = (stats.totalBase * exchangeRate).toFixed(0);
            // 基礎貨幣為 JPY
            const baseCurrency = CURRENCY_OPTIONS[0];
            
            // Function to handle click on Total Summary
            const handleTotalSummaryClick = () => {
                const totalSummaryData = {
                    isTotalSummary: true,
                    date: "全程",
                    title: "總花費",
                };
                handleOpenDailyDetail(totalSummaryData);
            };

            return (
                <div className="animate-in fade-in slide-in-from-bottom-6 duration-700 space-y-8">
                    
                    {/* Currency Rate Info Block (使用 Accent-Blue) */}
                    <div className="glass-panel p-5 rounded-2xl border border-[var(--accent-blue)]/50 shadow-lg">
                        <h4 className="text-lg font-bold text-[var(--accent-blue)] flex items-center gap-2 mb-4">
                            <Icons.Calculator size={20}/> 貨幣匯率資訊
                        </h4>
                        <div className="flex flex-col sm:flex-row sm:items-center justify-between space-y-3 sm:space-y-0 sm:space-x-4 p-3 bg-gray-100 rounded-xl border border-gray-300">
                            <span className="text-gray-600 font-medium whitespace-nowrap">
                                當前目標幣別:
                            </span>
                            <span className="text-xl font-bold text-[var(--accent-pink-dark)]">{selectedCurrency.name} ({selectedCurrency.code})</span>
                            <div className="text-sm text-gray-500 whitespace-nowrap">
                                {isRateLoading ? (
                                    <span className="flex items-center text-[var(--accent-blue)]">
                                        <Icons.Loader2 className="w-3 h-3 mr-1 animate-spin" /> 查詢中...
                                    </span>
                                ) : rateError ? (
                                    <span className="text-red-500 flex items-center">
                                        <Icons.AlertTriangle className="w-3 h-3 mr-1"/> 失敗
                                    </span>
                                ) : (
                                    `1 ${baseCurrency.code} ≈ ${exchangeRate.toFixed(4)} ${selectedCurrency.code}`
                                )}
                            </div>
                        </div>
                    </div>
                    {/* END Currency Rate Info Block */}

                    {/* 相簿搜尋連結 (使用 Accent-Blue 漸層) */}
                    <div className="glass-panel rounded-[2rem] overflow-hidden shadow-lg border border-gray-200">
                        <div className="bg-gradient-to-r from-[var(--accent-blue)] to-[var(--accent-blue)]/50 p-4 text-center relative shadow-md">
                            <h1 className="text-[var(--color-text)] text-lg font-bold flex items-center gap-2"><Icons.CameraOff size={24} className="text-[var(--accent-pink)] stroke-2.5" /> 相簿複合搜尋</h1>
                            <p className="text-gray-700 text-xs mt-1 opacity-80">點擊前往獨立搜尋頁面 (https://oliver603-juang.github.io/photo-map/)</p>
                        </div>
                        <div className="p-6">
                            <a href="https://oliver603-juang.github.io/photo-map/" target="_blank" rel="noreferrer" className="w-full bg-[var(--accent-blue)] hover:bg-[var(--accent-blue-dark)] text-white font-bold py-3.5 rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2 text-lg border border-[var(--accent-blue)]/30">
                                <Icons.UpRightFromSquare size={20} />
                                <span>開啟相簿搜尋器</span>
                            </a>
                        </div>
                    </div>

                    {/* AI 智慧購物車方框 (使用 Accent-Pink 漸層) */}
                    <div className="glass-panel rounded-[2rem] overflow-hidden shadow-lg border border-gray-200">
                        <div className="bg-gradient-to-r from-[var(--accent-pink)] to-[var(--accent-pink-dark)]/50 p-4 text-center relative shadow-md">
                            <h1 className="text-[var(--color-text)] text-lg font-bold flex items-center gap-2"><Icons.ShoppingBag size={24} className="text-[var(--accent-blue)] stroke-2.5" /> AI 智慧購物車</h1>
                            <p className="text-gray-700 text-xs mt-1 opacity-80">點擊前往購物清單 AI 助理頁面</p>
                        </div>
                        <div className="p-6">
                            <a href="https://oliver603-juang.github.io/shopping-cart-ai/" target="_blank" rel="noreferrer" className="w-full bg-[var(--accent-pink)] hover:bg-[var(--accent-pink-dark)]/80 text-[var(--color-text)] font-bold py-3.5 rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2 text-lg border border-[var(--accent-pink)]/30">
                                <Icons.UpRightFromSquare size={20} />
                                <span>開啟購物助理</span>
                            </a>
                        </div>
                    </div>
                    {/* END NEW BLOCK */}

                    <div className="space-y-4">
                        <div className="flex items-center justify-between">
                            {/* 使用 Accent-Pink 星號 */}
                            <h3 className="text-xl font-black text-[var(--color-text)] ml-2 flex items-center gap-2"><Icons.Star className="text-[var(--accent-pink)]" fill="var(--accent-pink)" /> 每日花費</h3>
                            {/* 使用 Accent-Blue 按鈕 */}
                            <button onClick={handleOpenEmailClick} className="text-xs font-bold text-white bg-[var(--accent-blue)] px-3 py-1.5 rounded-full hover:bg-[var(--accent-blue-dark)] transition-colors flex items-center gap-1 shadow-md"><Icons.Mail size={14} className="text-white"/> 發送報表</button>
                        </div>
                        {dailyStats.map((day) => (
                            <div key={day.dayId} onClick={() => handleOpenDailyDetail(day)} className="bg-white/90 p-5 rounded-2xl shadow-md border border-gray-200 flex justify-between items-center transition-transform hover:-translate-y-1 hover:border-[var(--accent-pink)] cursor-pointer">
                                <div className="flex items-center gap-4">
                                    <div className={`${day.themeColor} px-3 py-1 rounded-lg text-xs font-black text-[var(--color-text)] shadow-sm`}>{day.date}</div>
                                    <div className="font-bold text-[var(--color-text)]">{day.title}</div>
                                </div>
                                <div className="text-right">
                                    <div className="text-[10px] font-bold text-gray-500 uppercase">Total ({selectedCurrency.code})</div>
                                    {/* 使用 Accent-Pink-Dark */}
                                    <div className="text-lg font-mono font-black text-[var(--accent-pink-dark)]">{selectedCurrency.symbol} {(day.totalBase * exchangeRate).toFixed(0).toLocaleString()}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                    {/* 總費用摘要 (點擊觸發總明細) - 使用 Accent-Pink/Accent-Blue */}
                    <div 
                        className="glass-panel p-5 rounded-[2rem] border border-[var(--accent-pink)]/50 shadow-lg mt-8 cursor-pointer hover:bg-white/70 transition-colors"
                        onClick={handleTotalSummaryClick}
                    >
                        <div className="flex justify-between items-center">
                            {/* 使用 Accent-Pink */}
                            <h4 className="text-lg font-bold text-[var(--accent-pink)] flex items-center gap-2">
                                <Icons.Wallet size={20} className="text-[var(--accent-pink-dark)]"/> 總花費估算
                            </h4>
                            <div className="text-right">
                                <div className="text-sm font-bold text-gray-500">總計 ({baseCurrency.code}): {baseCurrency.symbol} {stats.totalBase.toLocaleString()}</div>
                                {/* 使用 Accent-Blue 霓虹文字 */}
                                <div className="text-2xl font-mono font-black text-[var(--accent-blue)] neon-text-blue">
                                    {selectedCurrency.symbol} {convertedTotal.toLocaleString()} ({selectedCurrency.code})
                                </div>
                            </div>
                        </div>
                        <p className="text-xs text-gray-500 text-right mt-2">(點擊查看完整明細)</p>
                    </div>
                </div>
            );
        };

        // 11. GuardTab - AI 防雷分頁
        const GuardTab = ({ tripData, flightInfo, hotelInfo, openKeyModal, aiLoading, setAiLoading }) => {
            const [flightAnalysis, setFlightAnalysis] = useState("");
            const [hotelAnalysis, setHotelAnalysis] = useState({});
            const [spotAnalysis, setSpotAnalysis] = useState({});
            const [aiInput, setAiInput] = useState("");
            const [aiGeneralResult, setAiGeneralResult] = useState("");
            
            // 將所有景點攤平，方便迭代
            const allSpots = useMemo(() => {
                return tripData.flatMap(day => day.spots.map(spot => ({
                    ...spot,
                    dayDate: day.date.split(' ')[0],
                    dayTitle: day.title,
                    // 為了 AI 檢查，將 id 設為唯一
                    id: spot.id 
                })));
            }, [tripData]);

            // AI 邏輯 functions
            const checkFlight = async () => {
                setAiLoading(true);
                setFlightAnalysis(<span className="flex items-center gap-2 typing-indicator">分析中...<span>.</span><span>.</span><span>.</span></span>);
                try {
                    const prompt = `檢查航班：去程 ${flightInfo.outbound.from} - ${flightInfo.outbound.to} (${flightInfo.outbound.date} ${flightInfo.outbound.dep}) 與 回程 ${flightInfo.inbound.from} - ${flightInfo.inbound.to} (${flightInfo.inbound.date} ${flightInfo.inbound.dep})。請查詢近期準點率、機場注意事項與潛在風險 (繁體中文)。`;
                    const res = await generateGeminiContent(prompt, null, true);
                    setFlightAnalysis(<MarkdownRenderer content={res} className="text-sm" />);
                } catch(e) { 
                    setFlightAnalysis("⚠️ 分析失敗，請檢查 API Key 或網路連線。");
                    if(e.message.includes("NO_API_KEY")) openKeyModal(true);
                }
                setAiLoading(false);
            };

            const checkHotel = async (hName, hLocation) => {
                const key = hName;
                setHotelAnalysis(p => ({...p, [key]: <span className="flex items-center gap-2 typing-indicator">🔍 掃雷中...<span>.</span><span>.</span><span>.</span></span>}));
                setAiLoading(true);

                try {
                    const prompt = `飯店防雷檢查：${hName} (${hLocation})，地點在日本東京近郊。請檢查：
                    1. 附近的超市/便利商店? (步行5分鐘內)
                    2. 停車資訊（若為自駕）?
                    3. 近期是否有嚴重負評(噪音/清潔)?
                    4. 離車站實際步行距離。
                    請簡短回覆，使用繁體中文。`;
                    const res = await generateGeminiContent(prompt, null, true);
                    setHotelAnalysis(p => ({...p, [key]: <MarkdownRenderer content={res} className="text-sm" />}));
                } catch(e) { 
                    setHotelAnalysis(p => ({...p, [key]: "分析失敗，請檢查 API Key 或網路連線。"})); 
                    if(e.message.includes("NO_API_KEY")) openKeyModal(true);
                }
                setAiLoading(false);
            };

            const checkSpot = async (spot) => {
                const fullTime = `${spot.dayDate} ${spot.time || ''}`.trim();
                const key = spot.id;
                
                setSpotAnalysis(p => ({...p, [key]: <span className="flex items-center gap-2 typing-indicator">🔍 掃雷中...<span>.</span><span>.</span><span>.</span></span>}));
                setAiLoading(true);

                try {
                    const prompt = `景點掃雷：${spot.name}，地點：日本東京近郊 ${spot.mapcodeDisplay}。
                    預計到訪時間：${fullTime}。
                    原始筆記：${spot.desc}
                    請檢查：1.該日期時間是否營業/公休? 2.近期是否有整修或關閉? 3.達人筆記 (建議停留時間/避雷針)。
                    請簡短回覆，使用繁體中文。`;
                    const res = await generateGeminiContent(prompt, null, true);
                    setSpotAnalysis(p => ({...p, [key]: <MarkdownRenderer content={res} className="text-sm" />}));
                } catch(e) { 
                    setSpotAnalysis(p => ({...p, [key]: "分析失敗，請檢查 API Key 或網路連線。"}));
                    if(e.message.includes("NO_API_KEY")) openKeyModal(true);
                }
                setAiLoading(false);
            };

            const analyzeGeneral = async () => {
                if(!aiInput) return;
                setAiGeneralResult(<span className="flex items-center gap-2 typing-indicator">分析中...<span>.</span><span>.</span><span>.</span></span>);
                setAiLoading(true);
                try {
                    const res = await generateGeminiContent(`請分析這段旅遊情報或攻略的潛在風險、誤區或過時資訊：${aiInput}`, null, true);
                    setAiGeneralResult(<MarkdownRenderer content={res} className="text-sm" />);
                } catch(e) { 
                    setAiGeneralResult("⚠️ 分析失敗，請檢查 API Key 或網路連線。");
                    if(e.message.includes("NO_API_KEY")) openKeyModal(true);
                }
                setAiLoading(false);
            };

            return (
                <div className="animate-in fade-in slide-in-from-bottom-6 duration-700 space-y-8">
                    <h1 className="text-3xl font-black text-[var(--color-text)] flex items-center gap-3 mb-6 px-2">
                        <Icons.Shield className="w-8 h-8 text-[var(--accent-pink-dark)]" strokeWidth={2.5} /> AI 旅遊防雷
                    </h1>

                    {/* 1. 航班/車程檢查 */}
                    <section className="glass-panel p-6 rounded-[2rem] border border-gray-200">
                        {/* 使用 Accent-Blue */}
                        <h3 className="font-bold text-[var(--accent-blue)] mb-4 flex items-center gap-2 text-xl"><Icons.Plane className="text-[var(--accent-blue)] w-5 h-5"/> 交通防雷</h3>
                        <div className="bg-gray-100 p-4 rounded-xl mb-4 border border-gray-300">
                            <div className="flex justify-between text-sm text-[var(--color-text)] mb-2 font-mono">
                                <span className="text-xs text-gray-500">去程 ({FLIGHT_INFO.outbound.flight})</span><span>{FLIGHT_INFO.outbound.date}</span>
                            </div>
                            <div className="flex justify-between text-sm text-[var(--color-text)] font-mono">
                                <span className="text-xs text-gray-500">回程 ({FLIGHT_INFO.inbound.flight})</span><span>{FLIGHT_INFO.inbound.date}</span>
                            </div>
                        </div>
                        {/* 使用 Accent-Blue/Accent-Pink-Dark 邊框 */}
                        {flightAnalysis && <div className="ai-result-box p-4 rounded-xl mb-4 border border-[var(--accent-blue)]/50">{flightAnalysis}</div>}
                        <button onClick={checkFlight} disabled={aiLoading} className="w-full bg-[var(--accent-blue)] hover:bg-[var(--accent-blue-dark)] text-white py-3 rounded-xl font-bold flex justify-center items-center gap-2 transition-colors shadow-[0_4px_0px_var(--accent-blue-dark)] active:translate-y-[2px] active:shadow-none">
                            {aiLoading ? <Icons.Loader2 className="animate-spin w-5 h-5"/> : <Icons.Search size={18} className="text-white"/>} AI 驗證航班
                        </button>
                    </section>

                    {/* 2. 住宿檢查 */}
                    <section className="glass-panel p-6 rounded-[2rem] border border-gray-200">
                        {/* 使用 Accent-Pink */}
                        <h3 className="font-bold text-[var(--accent-pink)] mb-4 flex items-center gap-2 text-xl"><Icons.Hotel className="text-[var(--accent-pink-dark)] w-5 h-5"/> 住宿防雷</h3>
                        <div className="space-y-4">
                            {hotelInfo.map((h,i) => (
                                <div key={i} className="bg-gray-100 p-4 rounded-xl border border-gray-300">
                                    <div className="flex justify-between items-start mb-2">
                                        <div>
                                            <div className="font-bold text-[var(--color-text)] text-base">{h.name}</div>
                                            <div className="text-xs text-gray-500 mt-1">{h.location}</div>
                                        </div>
                                        <button onClick={()=>checkHotel(h.name, h.location)} disabled={aiLoading} className="text-xs bg-[var(--accent-pink)] text-[var(--color-text)] px-3 py-1.5 rounded-full border border-[var(--accent-pink)] hover:bg-[var(--accent-pink-dark)]/50 transition-colors font-bold shrink-0 shadow-sm">
                                            {aiLoading ? <Icons.Loader2 size={12} className="animate-spin text-[var(--accent-pink-dark)]"/> : <Icons.Search size={12} className="text-[var(--accent-pink-dark)]"/>} 掃雷
                                        </button>
                                    </div>
                                    {hotelAnalysis[h.name] && <div className="ai-result-box p-3 rounded-xl mt-2">{hotelAnalysis[h.name]}</div>}
                                </div>
                            ))}
                        </div>
                    </section>

                    {/* 3. 景點檢查 */}
                    <section className="space-y-4">
                        <h3 className="text-2xl font-black text-[var(--color-text)] flex items-center gap-2 px-2">
                            <Icons.MapPin className="w-6 h-6 text-[var(--accent-blue)]" />
                            每日行程防雷
                        </h3>
                        
                        {allSpots.map((spot) => (
                            <div key={spot.id} className="glass-panel rounded-[2rem] p-6 guard-card hover:border-l-[var(--accent-pink)] transition-all">
                                <div className="flex items-start gap-4">
                                    <div className="w-10 h-10 bg-[var(--accent-pink)] rounded-full flex items-center justify-center text-[var(--color-text)] shrink-0 shadow-md">
                                        <span className="text-lg font-bold text-[var(--accent-pink-dark)]">{spot.dayDate}</span>
                                    </div>
                                    <div className="flex-1">
                                        <h4 className="font-black text-xl text-[var(--color-text)]">{spot.name}</h4>
                                        <p className="text-sm text-gray-500 mb-3">{spot.time} 抵達</p>

                                        {/* AI Result */}
                                        {spotAnalysis[spot.id] && (
                                            <div className="ai-result-box p-3 rounded-xl mb-3">{spotAnalysis[spot.id]}</div>
                                        )}

                                        <p className="text-xs font-bold text-[var(--accent-blue)]">達人筆記 (行程規劃者備註):</p>
                                        <p className="text-sm text-gray-700 mb-4">{spot.desc}</p>


                                        <button 
                                            onClick={() => checkSpot(spot)}
                                            disabled={aiLoading}
                                            className="w-full py-2 bg-[var(--accent-blue)] hover:bg-[var(--accent-blue-dark)] text-white rounded-xl text-sm font-bold transition-colors shadow-[0_4px_0px_var(--accent-blue-dark)] active:translate-y-[2px] active:shadow-none"
                                        >
                                            {aiLoading ? <Icons.Loader2 className="animate-spin w-4 h-4"/> : <Icons.Shield size={14}/>}
                                            AI 景點掃雷驗證 ({spot.time})
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </section>

                    {/* 4. 通用檢查 */}
                    <section className="glass-panel p-6 rounded-[2rem] border border-gray-200">
                        {/* 使用 Accent-Blue */}
                        <h3 className="font-bold text-[var(--color-text)] mb-4 flex items-center gap-2 text-xl"><Icons.Bot className="text-[var(--accent-blue)] w-5 h-5"/> 通用情報分析</h3>
                        <textarea value={aiInput} onChange={e=>setAiInput(e.target.value)} placeholder="貼上網路上找到的攻略、注意事項或餐廳評論，讓 AI 幫您檢查是否有風險或過時資訊..." className="w-full h-32 bg-gray-100 rounded-xl p-3 text-sm text-[var(--color-text)] outline-none focus:ring-2 focus:ring-[var(--accent-blue)] mb-3 border border-gray-300 resize-none"/>
                        <button onClick={analyzeGeneral} disabled={aiLoading||!aiInput} className="w-full bg-[var(--accent-blue)] hover:bg-[var(--accent-blue-dark)] text-white py-3 rounded-xl font-bold transition-colors shadow-[0_4px_0px_var(--accent-blue-dark)] active:translate-y-[2px] active:shadow-none">開始分析</button>
                        {aiGeneralResult && <div className="mt-4 p-4 ai-result-box rounded-xl">{aiGeneralResult}</div>}
                    </section>

                </div>
            );
        }

        // 12. 主應用程式
        function App() {
            const [activeTab, setActiveTab] = useState('itinerary'); 
            const [selectedDay, setSelectedDay] = useState('all'); 
            const [currentThemeIndex, setCurrentThemeIndex] = useState(0); 
            const [isThemeModalOpen, setIsThemeModalOpen] = useState(false); // 新增控制ThemeSelectModal的狀態
            const currentTheme = THEMES[currentThemeIndex];

            // 基礎貨幣為 JPY
            const BASE_CURRENCY_CODE = CURRENCY_OPTIONS[0].code;
            
            // --- Currency States (NEW) ---
            const [selectedCurrency, setSelectedCurrency] = useState(() => {
                // 讀取 localStorage 中的預設幣別，如果沒有，預設為 JPY
                const savedCode = localStorage.getItem('2025_xmas_trip_currency') || BASE_CURRENCY_CODE;
                return CURRENCY_OPTIONS.find(c => c.code === savedCode) || CURRENCY_OPTIONS[0];
            });
            const [exchangeRate, setExchangeRate] = useState(1);
            const [isRateLoading, setIsRateLoading] = useState(false);
            const [rateError, setRateError] = useState(null);
            
            // --- Itinerary States ---
            const [dayStartTimes, setDayStartTimes] = useState(() => { const initial = {}; RAW_KML_DATA.forEach(day => initial[day.dayId] = "09:30"); const saved = localStorage.getItem('2025_xmas_trip_start'); return saved ? JSON.parse(saved) : initial; });
            const [actualDepartures, setActualDepartures] = useState(() => { const saved = localStorage.getItem('2025_xmas_trip_deps'); return saved ? JSON.parse(saved) : {}; });
            const [stays, setStays] = useState(() => { const saved = localStorage.getItem('2025_xmas_trip_stays'); return saved ? JSON.parse(saved) : {}; });
            const [transportModes, setTransportModes] = useState({});
            const [tripData, setTripData] = useState([]);
            const [spotTicketCounts, setSpotTicketCounts] = useState(() => { const saved = localStorage.getItem('2025_xmas_trip_tickets'); return saved ? JSON.parse(saved) : {}; });

            // --- Stats & Expense States ---
            const [expenses, setExpenses] = useState({});
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isKeyModalOpen, setIsKeyModalOpen] = useState(false); 
            const [currentEditingSpot, setCurrentEditingSpot] = useState(null);
            const [expenseForm, setExpenseForm] = useState({ category: 'food', amount: '', note: '' });
            const [isAnalyzingReceipt, setIsAnalyzingReceipt] = useState(false);
            const [pendingReceipts, setPendingReceipts] = useState([]);
            const [quotaStatus, setQuotaStatus] = useState({ type: 'normal', text: 'API 額度正常' });
            
            // --- AI Guard States ---
            const [aiLoading, setAiLoading] = useState(false);
            
            // --- Email States ---
            const [isDailyDetailOpen, setIsDailyDetailOpen] = useState(false);
            const [selectedDailyStats, setSelectedDailyStats] = useState(null);
            const [isEmailModalOpen, setIsEmailModalOpen] = useState(false);
            const [emailInput, setEmailInput] = useState("");
            const [isSendingEmail, setIsSendingEmail] = useState(false);

            // Helper to set Key Modal state
            const openKeyModal = (state) => setIsKeyModalOpen(state); 

            // --- THEME SWITCHER LOGIC ---
            useEffect(() => {
                const savedIndex = parseInt(localStorage.getItem('themeIndex') || '0', 10);
                setCurrentThemeIndex(savedIndex % THEMES.length);
            }, []);

            useEffect(() => {
                document.body.className = `theme-${currentTheme.name}`;
                localStorage.setItem('themeIndex', currentThemeIndex);
            }, [currentThemeIndex, currentTheme.name]);
            
            // 處理 Modal 選擇主題
            const handleThemeSelection = (index) => {
                setCurrentThemeIndex(index);
                setIsThemeModalOpen(false);
            };
            // --- END THEME SWITCHER LOGIC ---


            // --- PERSISTENCE ---
            useEffect(() => { const saved = localStorage.getItem('2025_xmas_trip_exp'); if (saved) { try { const parsed = JSON.parse(saved); if (parsed && typeof parsed === 'object') { setExpenses(parsed); } } catch(e) {} } }, []);
            useEffect(() => { localStorage.setItem('2025_xmas_trip_exp', JSON.stringify(expenses)); }, [expenses]);
            useEffect(() => { localStorage.setItem('2025_xmas_trip_start', JSON.stringify(dayStartTimes)); }, [dayStartTimes]);
            useEffect(() => { localStorage.setItem('2025_xmas_trip_deps', JSON.stringify(actualDepartures)); }, [actualDepartures]);
            useEffect(() => { localStorage.setItem('2025_xmas_trip_stays', JSON.stringify(stays)); }, [stays]);
            useEffect(() => { localStorage.setItem('2025_xmas_trip_tickets', JSON.stringify(spotTicketCounts)); }, [spotTicketCounts]);
            useEffect(() => { if (window.emailjs) { window.emailjs.init("mYOFMMnqLdDxR0wjj"); } }, []);
            // Persist currency choice
            useEffect(() => {
                localStorage.setItem('2025_xmas_trip_currency', selectedCurrency.code);
            }, [selectedCurrency.code]);


            // --- CURRENCY LOGIC (UPDATED) ---
            const fetchExchangeRate = useCallback(async (base, target) => {
                if (base === target) {
                    setExchangeRate(1);
                    return;
                }
                
                setIsRateLoading(true);
                setRateError(null);
                
                try {
                    // 使用 Google Search Grounding 查詢即時匯率
                    const prompt = `目前的即時匯率是多少？1 ${base} 等於多少 ${target}? 請只回答數字。`;
                    const rateText = await generateGeminiContent(prompt, null, true);
                    
                    // 嘗試從 AI 回覆中解析數字
                    const rateMatch = rateText.match(/[\d.]+/);
                    const rate = rateMatch ? parseFloat(rateMatch[0]) : 0;

                    if (rate > 0) {
                        setExchangeRate(rate);
                    } else {
                        setRateError(`無法取得 ${base} 到 ${target} 的有效匯率。`);
                        setExchangeRate(1); 
                    }
                } catch (e) {
                    console.error("Exchange rate fetch error:", e);
                    if (e.message === 'NO_API_KEY') {
                        setRateError("匯率查詢失敗 (API Key 未設定)。請點擊右上角⚙️設定。");
                        openKeyModal(true);
                    } else {
                        setRateError(`匯率查詢失敗：${e.message}。將使用預設值 1。`);
                    }
                    setExchangeRate(1);
                } finally {
                    setIsRateLoading(false);
                }
            }, []);

            // Currency effect runs when selectedCurrency changes
            useEffect(() => {
                // 基礎貨幣固定為 JPY，目標貨幣為 selectedCurrency
                fetchExchangeRate(BASE_CURRENCY_CODE, selectedCurrency.code);
            }, [selectedCurrency.code, fetchExchangeRate]);
            // --- END CURRENCY LOGIC ---


             useEffect(() => {
                setTripData(prevData => {
                     return RAW_KML_DATA.map(day => {
                        // 初始設定為 Day1: 09:30, Day2+: 09:30
                        const startTimeStr = dayStartTimes[day.dayId] || (day.dayId === 'day1' ? FLIGHT_INFO.outbound.arr : "09:30");
                        let currentMinutes = timeToMinutes(startTimeStr);
                        
                        const processedSpots = day.spots.map((rawSpot, index) => {
                            const spotId = `${day.dayId}-s${index}`;
                            const stayStr = stays[spotId] || (rawSpot.isHotel ? "Overnight" : "2 hr");
                            const stayMinutes = parseStayDuration(stayStr);
                            
                            // 計算抵達時間
                            const arrivalTimeStr = minutesToTimeStr(currentMinutes);

                            let departureMinutes;
                            let isDeparted = false;
                            let actualDepTime = null;
                            if (actualDepartures[spotId]) {
                                actualDepTime = actualDepartures[spotId];
                                departureMinutes = timeToMinutes(actualDepTime);
                                isDeparted = true;
                            } else {
                                departureMinutes = currentMinutes + stayMinutes;
                            }
                            const departureTimeStr = minutesToTimeStr(departureMinutes);
                            
                            let nextStopInfo = null;
                            let travelMinutes = 0;
                            
                            if (index < day.spots.length - 1) {
                                const nextSpot = day.spots[index + 1];
                                
                                // 修正: 經緯度從 KML 導入後是 Lon, Lat，但這裡需要 Lat, Lon
                                const rawLonLat = rawSpot.lon + "," + rawSpot.lat;
                                const nextLonLat = nextSpot.lon + "," + nextSpot.lat;

                                const dist = getDistanceFromLatLonInKm(rawSpot.lat, rawSpot.lon, nextSpot.lat, nextSpot.lon); 
                                
                                const mode = transportModes[spotId] || 'car';
                                const speed = mode === 'car' ? 40 : 4; 
                                travelMinutes = Math.round((dist / speed) * 60);
                                const displayDriveMins = Math.round((dist / 40) * 60); 
                                const displayWalkMins = Math.round((dist / 4) * 60);
                                
                                nextStopInfo = {
                                    name: nextSpot.name, distance: `${dist} km`,
                                    driveTime: displayDriveMins > 60 ? `${Math.floor(displayDriveMins/60)}hr ${displayDriveMins%60}m` : `${displayDriveMins}m`,
                                    walkTime: displayWalkMins > 60 ? `${Math.floor(displayWalkMins/60)}hr ${displayWalkMins%60}m` : `${displayWalkMins}m`,
                                    // 修正: Google Maps 導航需要 Lat, Lon
                                    navLink: `https://www.google.com/maps/dir/?api=1&origin=${rawSpot.lat},${rawSpot.lon}&destination=${nextSpot.lat},${nextSpot.lon}&travelmode=driving`
                                };
                            }

                            // 更新下一站的起始時間
                            currentMinutes = departureMinutes + travelMinutes;
                            
                            // 解析 KML 的 mapCode（日文導航碼）
                            const mapCodeText = rawSpot.mapCode ? `MAPCODE: ${rawSpot.mapCode}` : "GPS Coordinates";

                            return { 
                                ...rawSpot, 
                                id: spotId, 
                                time: arrivalTimeStr, 
                                stay: stayStr, 
                                departureTime: departureTimeStr, 
                                isDeparted: isDeparted, 
                                actualDepTime: actualDepTime, 
                                mapcodeDisplay: mapCodeText, 
                                mapcodeLabel: rawSpot.mapCode ? "MAPCODE" : "GPS", 
                                weather: ["sunny", "cloudy"][Math.floor(Math.random()*2)], 
                                temp: "10°C", // 替換為日本冬天的溫度
                                gmapLink: `https://www.google.com/maps/search/?api=1&query=${rawSpot.lat},${rawSpot.lon}`, 
                                nextStop: nextStopInfo, 
                                ticket: rawSpot.ticket || null 
                            };
                        });
                        
                        // NOTE: 使用 PinkMorandi 和 GreenMorandi 交替
                        let themeColorClass;
                        // Since dayId is a string like "day1", "day2", we parse the number.
                        const dayNum = parseInt(day.dayId.replace('day', ''), 10);

                        if (currentTheme.name === 'PinkMorandi' || currentTheme.name === 'DarkMorandi') {
                           themeColorClass = dayNum % 2 === 1 ? "bg-[#FFC8DD]" : "bg-[#A0B7C6]"; // Pink or Blue
                        } else {
                           themeColorClass = dayNum % 2 === 1 ? "bg-[#E4C7C2]" : "bg-[#A8B5A3]"; // Soft Pink or Gray Green
                        }

                        return { ...day, spots: processedSpots, themeColor: themeColorClass };
                    });
                });
            }, [dayStartTimes, actualDepartures, transportModes, stays, currentTheme.name]);

            const handleTransportToggle = (spotId) => { setTransportModes(prev => ({ ...prev, [spotId]: prev[spotId] === 'walk' ? 'car' : 'walk' })); };
            const handleStayChangeNew = (spotId, newStay) => { setStays(prev => ({ ...prev, [spotId]: newStay })); };
            const handleDayStartTimeChange = (dayId, newTime) => { setDayStartTimes(prev => ({ ...prev, [dayId]: newTime })); };
            const handleDepartureToggle = (spotId) => { setActualDepartures(prev => { const newState = { ...prev }; if (newState[spotId]) { delete newState[spotId]; } else { const now = new Date(); const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`; newState[spotId] = timeStr; } return newState; }); };
            const getTicketCounts = (spotId) => spotTicketCounts[spotId] || { adult: 2, child: 2 };

            const handleOpenMap = () => { let points = []; if (selectedDay === 'all') { tripData.forEach(day => { day.spots.forEach(spot => { const coord = `${spot.lat},${spot.lon}`; if (points.length === 0 || points[points.length - 1] !== coord) { points.push(coord); } }); }); } else { const currentDay = tripData.find(d => d.dayId === selectedDay); if (currentDay) { points = currentDay.spots.map(s => `${s.lat},${s.lon}`); } } if (points.length > 0) { window.open(`https://www.google.com/maps/dir/${points.join('/')}`, '_blank'); } };

            const openExpenseModal = (spot) => { setCurrentEditingSpot(spot); setExpenseForm({ category: 'food', amount: '', note: '' }); setPendingReceipts([]); setQuotaStatus({ type: 'normal', text: 'API 額度正常' }); setIsModalOpen(true); };
            const saveExpense = () => { const newRecords = []; if (expenseForm.amount && !isNaN(expenseForm.amount)) { newRecords.push({ id: Date.now(), category: expenseForm.category, amount: parseInt(expenseForm.amount), note: expenseForm.note }); } pendingReceipts.forEach((p, idx) => { if (p.isChecked && !p.isAnalyzing && p.amount > 0) { newRecords.push({ id: Date.now() + idx + 1, category: expenseForm.category, amount: parseInt(p.amount), note: p.note }); } }); if (newRecords.length > 0) { const spotId = currentEditingSpot.id; setExpenses(prev => ({ ...prev, [spotId]: [...(prev[spotId] || []), ...newRecords] })); } setIsModalOpen(false); };
            const deleteExpense = (spotId, recordId) => { setExpenses(prev => ({ ...prev, [spotId]: prev[spotId].filter(r => r.id !== recordId) })); };
            const togglePendingReceipt = (id) => { setPendingReceipts(prev => prev.map(p => p.id === id ? { ...p, isChecked: !p.isChecked } : p)); };
            const removePendingReceipt = (id) => { setPendingReceipts(prev => prev.filter(p => p.id !== id)); };

            const handleImageUpload = async (e) => { 
                const files = Array.from(e.target.files); 
                if (files.length === 0) return; 
                const inputElement = e.target; 
                const newItems = files.map(file => ({ id: Math.random().toString(36).substr(2, 9), file, amount: 0, note: '分析中...', isAnalyzing: true, isChecked: true })); 
                setPendingReceipts(prev => [...prev, ...newItems]); 
                setIsAnalyzingReceipt(true); 
                setQuotaStatus({ type: 'normal', text: '高速分析中 (Paid Key)' }); 
                
                await Promise.all(newItems.map(async (item) => { 
                    return new Promise((resolve) => { 
                        const reader = new FileReader(); 
                        reader.onloadend = async () => { 
                            const base64String = reader.result; 
                            try { 
                                // Adjust prompt to explicitly request JPY
                                const prompt = `Analyze this receipt image. Extract: 1. Total amount in JPY (Japanese Yen). 2. Store name in Chinese/Japanese. 3. Date in YYYY/MM/DD HH:MM format. Return JSON: {"amount": <number>, "store": "<string>", "date": "<string>"}.`; 
                                let responseText = await generateGeminiContent(prompt, base64String); 
                                let result; 
                                const jsonMatch = responseText.match(/\{[\s\S]*\}/); 
                                if (jsonMatch) { 
                                    // 處理有 JSON 圍欄的情況
                                    try {
                                        result = JSON.parse(jsonMatch[0].replace(/```json/g, '').replace(/```/g, '').trim());
                                    } catch (e) {
                                        // 嘗試直接解析
                                        result = JSON.parse(responseText.replace(/```json/g, '').replace(/```/g, '').trim());
                                    }
                                } else { 
                                    // 嘗試直接解析無圍欄的文本
                                    result = JSON.parse(responseText.trim());
                                } 
                                if (result && (result.amount || result.amount === 0)) { 
                                    const cleanAmount = String(result.amount).replace(/[^0-9.]/g, ''); 
                                    const autoNote = (result.date ? result.date + " " : "") + (result.store || ""); 
                                    setPendingReceipts(prev => prev.map(p => p.id === item.id ? { ...p, amount: cleanAmount, note: autoNote, isAnalyzing: false } : p)); 
                                } else { 
                                    throw new Error("Invalid JSON"); 
                                };
                            } catch (error) { 
                                let errorMsg = '辨識失敗'; 
                                if (error.message === 'NO_API_KEY') { 
                                    errorMsg = '請設定 API Key'; 
                                    setQuotaStatus({ type: 'error', text: '❌ 未設定 API 金鑰' }); 
                                    setIsKeyModalOpen(true);
                                } 
                                setPendingReceipts(prev => prev.map(p => p.id === item.id ? { ...p, amount: 0, note: errorMsg, isAnalyzing: false, isChecked: false } : p)); 
                            } finally { 
                                resolve(); 
                            } 
                        }; 
                        reader.readAsDataURL(item.file); 
                    }); 
                })); 
                
                setIsAnalyzingReceipt(false); 
                setQuotaStatus({ type: 'normal', text: '分析完成' }); 
                inputElement.value = ''; 
            };

            const handleOpenDailyDetail = (dayStats) => { setSelectedDailyStats(dayStats); setIsDailyDetailOpen(true); };
            const handleOpenEmailClick = () => { const savedEmail = localStorage.getItem('user_email') || "your@email.com"; setEmailInput(savedEmail); setIsEmailModalOpen(true); };
            
            const handleSendEmail = async () => {
                if (!emailInput) { console.log("請輸入信箱"); return; }
                setIsSendingEmail(true); localStorage.setItem('user_email', emailInput);
                const baseCurrency = CURRENCY_OPTIONS[0];

                try {
                    let tableRows = ""; let grandTotal = 0;
                    tripData.forEach(day => {
                        tableRows += `<tr style="background-color: #f5f5f5;"><td colspan="4" style="border: 1px solid #ddd; padding: 8px; font-weight: bold; color: #333;">${day.date} - ${day.title}</td></tr>`;
                        day.spots.forEach(spot => {
                            const spotExpenses = expenses[spot.id] || [];
                            spotExpenses.forEach(record => { tableRows += `<tr><td style="border: 1px solid #ddd; padding: 8px;">${day.date}</td><td style="border: 1px solid #ddd; padding: 8px;">${spot.name} (${EXPENSE_CATEGORIES.find(c => c.id === record.category)?.label || record.category})</td><td style="border: 1px solid #ddd; padding: 8px;">${record.note || '-'}</td><td style="border: 1px solid #ddd; padding: 8px;">${record.amount}</td></tr>`; grandTotal += (record.amount || 0); });
                            if (spot.ticket) { const counts = getTicketCounts(spot.id); const ticketCost = (spot.ticket.adult * counts.adult + spot.ticket.child * counts.child); if (ticketCost > 0) { tableRows += `<tr><td style="border: 1px solid #ddd; padding: 8px;">${day.date}</td><td style="border: 1px solid #ddd; padding: 8px;">${spot.name} (門票)</td><td style="border: 1px solid #ddd; padding: 8px;">全票${counts.adult}, 優待${counts.child}</td><td style="border: 1px solid #ddd; padding: 8px;">${ticketCost}</td></tr>`; grandTotal += ticketCost; } }
                        });
                    });
                    
                    const emailAccentPink = '#FFC8DD';
                    const emailAccentPinkDark = '#E07A5F';
                    const htmlMessage = `<h2 style="color: #333;">${tripTitle} - 花費明細</h2><table style="width:100%; border-collapse: collapse; font-family: sans-serif; border: 1px solid #ddd;"><thead><tr style="background-color: ${emailAccentPink}; color: #333;"><th style="border: 1px solid #ddd; padding: 12px;">日期</th><th style="border: 1px solid #ddd; padding: 12px;">地點/項目</th><th style="border: 1px solid #ddd; padding: 12px;">備註</th><th style="border: 1px solid #ddd; padding: 12px;">金額 (${baseCurrency.code})</th></tr></thead><tbody>${tableRows}</tbody><tfoot><tr style="background-color: #f5f5f5;"><td colspan="3" style="border: 1px solid #ddd; padding: 12px; text-align: right; font-weight: bold; color: #333;">總計</td><td style="border: 1px solid #ddd; padding: 12px; font-weight: bold; color: ${emailAccentPinkDark};">${baseCurrency.symbol} ${grandTotal.toLocaleString()}</td></tr></tfoot></table><p style="font-size: 12px; color: #666; margin-top: 20px;">本信件由旅遊規劃 App 自動發送。</p>`;
                    const params = { email: emailInput, to_email: emailInput, recipient: emailInput, subject: `${tripTitle} 花費報表_${new Date().toLocaleDateString()}`, message: htmlMessage }; 
                    await window.emailjs.send("service_5yh7x6g", "template_dlbyml8", params);
                    
                    console.log("Email sent successfully!"); 
                    setIsEmailModalOpen(false);
                } catch (error) { 
                    console.error("Email Error:", error); 
                    console.log("Email failed to send: " + JSON.stringify(error)); 
                } finally { 
                    setIsSendingEmail(false); 
                }
            };


            // --- Stats Calculation Logic ---
            const stats = useMemo(() => { 
                let totalBase = 0; 
                const currentExpenses = expenses || {};
                Object.values(currentExpenses).forEach(recs => {
                    if (Array.isArray(recs)) {
                        totalBase += recs.reduce((sum, r) => sum + (r.amount || 0), 0);
                    }
                });

                if (tripData) {
                    tripData.forEach(day => {
                        if (day.spots) {
                            day.spots.forEach(spot => {
                                if (spot.ticket) {
                                    const counts = spotTicketCounts[spot.id] || { adult: 2, child: 2 }; 
                                    totalBase += (spot.ticket.adult * counts.adult + spot.ticket.child * counts.child);
                                }
                            });
                        }
                    });
                }
                // NOTE: Change totalJpy to totalBase, keeping the original JPY amounts as the base currency.
                return { totalBase }; 
            }, [expenses, tripData, spotTicketCounts]);

            const dailyStats = useMemo(() => {
                if (!tripData) return [];
                const currentExpenses = expenses || {};
                return tripData.map(day => {
                    let dayTotal = 0;
                    if (day.spots) {
                        day.spots.forEach(spot => {
                            const spotExpenses = currentExpenses[spot.id] || [];
                            if (Array.isArray(spotExpenses)) {
                                dayTotal += spotExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                            }
                            if (spot.ticket) {
                                const counts = spotTicketCounts[spot.id] || { adult: 2, child: 2 };
                                dayTotal += (spot.ticket.adult * counts.adult + spot.ticket.child * counts.child);
                            }
                        });
                    }
                    // NOTE: Renamed totalJpy to totalBase for consistency
                    return { ...day, totalBase: dayTotal };
                });
            }, [expenses, tripData, spotTicketCounts]);

            // --- Dynamic Title Calculation ---
            const tripTitle = useMemo(() => {
                // 使用 KML 文件的名稱
                return "2026寒假東京外郊親子行"; 
            }, [RAW_KML_DATA]);


            return (
                <div className="min-h-screen pb-24">
                    {/* 調整 Nav Bar 背景色 */}
                    <nav className="sticky top-0 z-50 bg-[var(--bg-main)]/90 backdrop-blur-md border-b border-gray-200 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-20">
                                <div className="flex items-center gap-3">
                                    {/* 1. Logo 圖片區塊 */}
									<img 
										src="icon.png" 
										alt="App Logo" 
										className="w-12 h-12 rounded-full object-cover bg-white border-2 border-[var(--accent-pink)] shadow-lg shrink-0"
									/>
                                    <div className="flex flex-col justify-center">
                                        {/* 動態主標題 */}
                                        <div className="font-extrabold text-2xl tracking-tight text-[var(--color-text)] flex items-center gap-2 neon-text">{tripTitle} <Icons.Smile className="text-[var(--accent-pink-dark)]" size={20}/></div>
                                        {/* 使用 Accent-Blue 副標題 - 使用圓角按鈕樣式 */}
                                        <div className="text-xs font-bold text-gray-700 tracking-widest uppercase bg-gray-200 px-3 py-0.5 rounded-full inline-block border border-gray-300 w-fit mt-0.5">STYLE TRIP PLANNER</div>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2 navbar-actions">
                                    
                                    {/* NEW: Global Currency Switcher (PC/Mobile) - 移到頂部，取代舊的 PC 專用區塊 */}
                                    <div className="hidden sm:block">
                                        <CurrencySwitcher 
                                            selectedCurrency={selectedCurrency}
                                            exchangeRate={exchangeRate}
                                            isRateLoading={isRateLoading}
                                            rateError={rateError}
                                            setSelectedCurrency={setSelectedCurrency}
                                            baseCurrencyCode={BASE_CURRENCY_CODE}
                                        />
                                    </div>
                                    
                                    {/* NEW: Mobile/Tablet Currency Switcher & Total (Small Screen Only) */}
                                    <div className="sm:hidden flex items-center gap-2">
                                        <CurrencySwitcher 
                                            selectedCurrency={selectedCurrency}
                                            exchangeRate={exchangeRate}
                                            isRateLoading={isRateLoading}
                                            rateError={rateError}
                                            setSelectedCurrency={setSelectedCurrency}
                                            baseCurrencyCode={BASE_CURRENCY_CODE}
                                        />
                                        <div className="text-right">
                                            <div className="text-[10px] font-bold text-gray-500 uppercase bg-gray-100 px-2 rounded-full border border-gray-300">總計 ({selectedCurrency.code})</div>
                                            <div className="font-mono font-bold text-[var(--accent-pink-dark)] text-lg">{selectedCurrency.symbol} {(stats.totalBase * exchangeRate).toFixed(0).toLocaleString()}</div>
                                        </div>
                                    </div>

                                    {/* NEW: 風格切換按鈕 (PC/Mobile) */}
                                    <button 
                                        onClick={() => setIsThemeModalOpen(true)}
                                        className="p-2.5 rounded-full bg-gray-100 hover:bg-gray-200 text-[var(--accent-pink-dark)] border border-gray-300 transition-colors hidden sm:flex"
                                    >
                                        <Icons.Sparkles size={20} />
                                    </button>
                                    
                                    {/* NEW: 導航按鈕 (PC/Mobile) */}
                                    <button onClick={handleOpenMap} className="p-2.5 rounded-full bg-gray-100 hover:bg-gray-200 text-[var(--accent-pink-dark)] border border-gray-300 transition-colors">
                                        <Icons.Map size={20} />
                                    </button>
                                    
                                    {/* NEW: 設定按鈕 (PC/Mobile) */}
                                    <button onClick={() => setIsKeyModalOpen(true)} className="p-2.5 rounded-full bg-gray-100 hover:bg-gray-200 text-[var(--accent-blue)] border border-gray-300 transition-colors">
                                        <Icons.Settings size={20} />
                                    </button>
                                    
                                    <div className="text-right hidden sm:block">
                                        <div className="text-[10px] font-bold text-gray-500 uppercase bg-gray-100 px-2 rounded-full border border-gray-300">總計 ({selectedCurrency.code})</div>
                                        {/* 使用 Accent-Pink-Dark 總花費 */}
                                        <div className="font-mono font-bold text-[var(--accent-pink-dark)] text-lg">{selectedCurrency.symbol} {(stats.totalBase * exchangeRate).toFixed(0).toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-5xl mx-auto p-4 md:p-8">
                        {activeTab === 'itinerary' && (
                            <ItineraryTab 
                                tripData={tripData} selectedDay={selectedDay} setSelectedDay={setSelectedDay} dayStartTimes={dayStartTimes} handleDayStartTimeChange={handleDayStartTimeChange} handleDepartureToggle={handleDepartureToggle} handleTransportToggle={handleTransportToggle} handleStayChangeNew={handleStayChangeNew} openExpenseModal={openExpenseModal} transportModes={transportModes} expenses={expenses} getTicketCounts={getTicketCounts} STAY_OPTIONS={STAY_OPTIONS}
                            />
                        )}

                        {activeTab === 'info' && (
                            <InfoTab 
                            />
                        )}

                        {activeTab === 'stats' && (
                            <StatsTab 
                                dailyStats={dailyStats} 
                                handleOpenDailyDetail={handleOpenDailyDetail} 
                                handleOpenEmailClick={handleOpenEmailClick} 
                                stats={stats} 
                                selectedCurrency={selectedCurrency} 
                                exchangeRate={exchangeRate}
                                setSelectedCurrency={setSelectedCurrency}
                                tripData={tripData} 
                                isRateLoading={isRateLoading} 
                                rateError={rateError} 
                            />
                        )}

                        {/* NEW: AI 防雷分頁 */}
                        {activeTab === 'guard' && (
                            <GuardTab
                                tripData={tripData}
                                flightInfo={FLIGHT_INFO}
                                hotelInfo={HOTEL_INFO}
                                openKeyModal={openKeyModal} 
                                aiLoading={aiLoading}
                                setAiLoading={setAiLoading}
                            />
                        )}
                    </main>

                    {/* Footer Navigation (調整背景色和切換按鈕整合) */}
                    <div className="fixed bottom-0 w-full bg-[var(--bg-main)]/95 backdrop-blur-md border-t border-gray-300 pb-safe z-40 flex justify-around py-3 text-xs font-bold text-gray-500">
                        
                        {/* 行程 */}
                        <button onClick={() => setActiveTab('itinerary')} className={`flex flex-col items-center gap-1 nav-button-wrapper ${activeTab === 'itinerary' ? 'text-[var(--accent-pink-dark)]' : 'hover:text-gray-700'}`}><Icons.List size={22} /> 行程</button>
                        
                        {/* 資訊 */}
                        <button onClick={() => setActiveTab('info')} className={`flex flex-col items-center gap-1 nav-button-wrapper ${activeTab === 'info' ? 'text-[var(--accent-blue)]' : 'hover:text-gray-700'}`}><Icons.LayoutGrid size={22} /> 資訊</button>
                        
                        {/* 統計 */}
                        <button onClick={() => setActiveTab('stats')} className={`flex flex-col items-center gap-1 nav-button-wrapper ${activeTab === 'stats' ? 'text-[var(--accent-pink-dark)]' : 'hover:text-gray-700'}`}><Icons.Calculator size={22} /> 統計</button>
                        
                        {/* 防雷 */}
                        <button onClick={() => setActiveTab('guard')} className={`flex flex-col items-center gap-1 nav-button-wrapper ${activeTab === 'guard' ? 'text-[var(--accent-blue)]' : 'hover:text-gray-700'}`}><Icons.Shield size={22} /> 防雷</button>
                        
                        {/* NEW: 主題切換按鈕 (Mobile Only) */}
                        <button 
                            onClick={() => setIsThemeModalOpen(true)}
                            className={`flex flex-col items-center gap-1 nav-button-wrapper sm:hidden ${activeTab === 'theme' ? 'text-[var(--accent-pink-dark)]' : 'hover:text-gray-700'}`}
                        >
                            <Icons.Sparkles size={22} />
                            <span>風格</span>
                        </button>
                        
                    </div>

                    {/* Modal Definitions */}
                    <ApiKeyModal isOpen={isKeyModalOpen} onClose={() => setIsKeyModalOpen(false)} /> 
                    <ThemeSelectModal 
                        isOpen={isThemeModalOpen} 
                        onClose={() => setIsThemeModalOpen(false)} 
                        setCurrentThemeIndex={setCurrentThemeIndex}
                        currentThemeIndex={currentThemeIndex}
                    />
                    
                    <ExpenseModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} currentEditingSpot={currentEditingSpot} expenseForm={expenseForm} setExpenseForm={setExpenseForm} handleImageUpload={handleImageUpload} pendingReceipts={pendingReceipts} togglePendingReceipt={togglePendingReceipt} removePendingReceipt={removePendingReceipt} saveExpense={saveExpense} expenses={expenses} deleteExpense={deleteExpense} isAnalyzingReceipt={isAnalyzingReceipt} quotaStatus={quotaStatus} />
                    
                    <DailyDetailModal isOpen={isDailyDetailOpen} onClose={() => setIsDailyDetailOpen(false)} dayData={selectedDailyStats} allExpenses={expenses} spotTicketCounts={spotTicketCounts} selectedCurrency={selectedCurrency} exchangeRate={exchangeRate} tripData={tripData} />

                    <EmailModal isOpen={isEmailModalOpen} onClose={() => setIsEmailModalOpen(false)} emailInput={emailInput} setEmailInput={setEmailInput} handleSendEmail={handleSendEmail} isSendingEmail={isSendingEmail} tripTitle={tripTitle} />
                </div>
            );
        }

        // FIX: 確保使用正確的 ReactDOM 模組和 createRoot 啟動
        const container = document.getElementById('root');
        const ReactDomModule = typeof ReactDOM !== 'undefined' ? ReactDOM : window.ReactDOM;

        if (ReactDomModule && ReactDomModule.createRoot) {
             const root = ReactDomModule.createRoot(container);
             root.render(<App />);
        } else {
             console.error("ReactDOM.createRoot not found. Attempting legacy render.");
             ReactDomModule.render(<App />, container);
        }
    </script>
	<script>
		if ('serviceWorker' in navigator) {
			window.addEventListener('load', () => {
				navigator.serviceWorker.register('./sw.js')
					.then(reg => console.log('Service Worker 註冊成功', reg))
					.catch(err => console.log('Service Worker 註冊失敗', err));
			});
		}
	</script>
</body>
</html>

